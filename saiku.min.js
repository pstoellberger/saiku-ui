var Settings={VERSION:"Saiku 3.0-SNAPSHOT",BIPLUGIN:false,BIPLUGIN5:false,BASE_URL:"",TOMCAT_WEBAPP:"/saiku",REST_MOUNT_POINT:"/rest/saiku/",DIMENSION_PREFETCH:true,DIMENSION_SHOW_ALL:true,DIMENSION_SHOW_REDUCED:false,ERROR_LOGGING:false,ERROR_TOLERANCE:3,QUERY_PROPERTIES:{"saiku.olap.query.automatic_execution":true,"saiku.olap.query.nonempty":true,"saiku.olap.query.nonempty.rows":true,"saiku.olap.query.nonempty.columns":true,"saiku.ui.render.mode":"table","saiku.olap.query.filter":true,"saiku.olap.result.formatter":"flattened"},TABLE_LAZY:true,TABLE_LAZY_SIZE:1000,TABLE_LAZY_LOAD_ITEMS:20,TABLE_LAZY_LOAD_TIME:20,CELLSET_FORMATTER:"flattened",RESULT_LIMIT:0,MEMBERS_FROM_RESULT:true,MEMBERS_LIMIT:3000,MEMBERS_SEARCH_LIMIT:75,ALLOW_IMPORT_EXPORT:false,ALLOW_PARAMETERS:false,PLUGINS:["Chart"],DEFAULT_VIEW_STATE:"view",DEMO:false,TELEMETRY_SERVER:"http://telemetry.analytical-labs.com:7000",LOCALSTORAGE_EXPIRATION:10*60*60*1000,UPGRADE:false,REPO_BASE:null};Settings.GET=function(){var g=document.location.search;g=g.split("+").join(" ");var h={},i,f=/[?&]?([^=]+)=([^&]*)/g;while(i=f.exec(g)){var j=decodeURIComponent(i[2]);if(!isNaN(j)){j=parseInt(j)}if(j==="true"){j=true}if(j==="false"){j=false}h[decodeURIComponent(i[1]).toUpperCase()]=j}return h}();_.extend(Settings,Settings.GET);Settings.PARAMS=(function(){var c={};for(var d in Settings){if(d.match("^PARAM")=="PARAM"){c[d]=Settings[d]}}return c}());Settings.REST_URL=Settings.BASE_URL+Settings.TOMCAT_WEBAPP+Settings.REST_MOUNT_POINT;if(Settings.MODE=="table"){Settings.DIMENSION_PREFETCH=false;$("body, html").css("min-height",0);$("body, html").css("min-width",0)}if(Settings.BIPLUGIN5){Settings.BIPLUGIN=true}Settings.INITIAL_QUERY=false;if(document.location.hash){var hash=document.location.hash;if(hash.length>11&&hash.substring(1,11)=="query/open"){Settings.INITIAL_QUERY=true}}if(!Array.prototype.indexOf){Array.prototype.indexOf=function(d){var e=this.length>>>0;var f=Number(arguments[1])||0;f=(f<0)?Math.ceil(f):Math.floor(f);if(f<0){f+=e}for(;f<e;f++){if(f in this&&this[f]===d){return f}}return -1}}var tagsToReplace={"&":"&amp;","<":"&lt;",">":"&gt;"};function replaceTag(b){return tagsToReplace[b]||b}function safe_tags_replace(b){return b.replace(/[&<>]/g,replaceTag)}if($.blockUI){$.blockUI.defaults.css={};$.blockUI.defaults.overlayCSS={};$.blockUI.defaults.blockMsgClass="processing";$.blockUI.defaults.fadeOut=0;$.blockUI.defaults.fadeIn=0;$.blockUI.defaults.ignoreIfBlocked=false}if(window.location.hostname&&(window.location.hostname=="dev.analytical-labs.com"||window.location.hostname=="demo.analytical-labs.com")){Settings.USERNAME="admin";Settings.PASSWORD="admin";Settings.DEMO=true;Settings.UPGRADE=false}var isIE=(function(){var f,e=3;var d=navigator.appVersion;if(d.indexOf("MSIE")!=-1){e=parseFloat(d.split("MSIE ")[1]);return e>4?e:false}return false}());var SaikuOlapQueryTemplate={queryModel:{axes:{FILTER:{mdx:null,filters:[],sortOrder:null,sortEvaluationLiteral:null,hierarchizeMode:null,location:"FILTER",hierarchies:[],nonEmpty:false,},COLUMNS:{mdx:null,filters:[],sortOrder:null,sortEvaluationLiteral:null,hierarchizeMode:null,location:"COLUMNS",hierarchies:[],nonEmpty:true,},ROWS:{mdx:null,filters:[],sortOrder:null,sortEvaluationLiteral:null,hierarchizeMode:null,location:"ROWS",hierarchies:[],nonEmpty:true,}},visualTotals:false,visualTotalsPattern:null,lowestLevelsOnly:false,details:{axis:"COLUMNS",location:"BOTTOM",measures:[]},calculatedMeasures:[]},queryType:"OLAP",type:"QUERYMODEL"};var SaikuOlapQueryHelper=function(b){this.query=b};SaikuOlapQueryHelper.prototype.model=function(){return this.query.model};SaikuOlapQueryHelper.prototype.clearAxis=function(b){this.model().queryModel.axes[b].hierarchies=[]};SaikuOlapQueryHelper.prototype.getHierarchy=function(e){for(var g in this.model().queryModel.axes){var h=this.model().queryModel.axes[g];var f=_.find(h.hierarchies,function(a){return(a&&a.name==e)});if(f){return f}}return null};SaikuOlapQueryHelper.prototype.moveHierarchy=function(k,m,h,i){var l=this.getHierarchy(h);var n=this.model().queryModel.axes[k].hierarchies.indexOf(l);var j=this.model().queryModel.axes[m].hierarchies;this.model().queryModel.axes[k].hierarchies.splice(n,1);if(typeof i!="undefined"&&i>-1&&j.length>i){j.splice(i,0,l);return}j.push(l)};SaikuOlapQueryHelper.prototype.removeHierarchy=function(f){var g=this.getHierarchy(f);if(!g){return null}var h=this.findAxisForHierarchy(f);if(h){var e=h.hierarchies.indexOf(g);h.hierarchies.splice(e,1)}return g};SaikuOlapQueryHelper.prototype.findAxisForHierarchy=function(f){for(var h in this.model().queryModel.axes){var i=this.model().queryModel.axes[h];if(i.hierarchies&&i.hierarchies.length>0){for(var j=0,g=i.hierarchies.length;j<g;j++){if(i.hierarchies[j].name==f){return i}}}}return null};SaikuOlapQueryHelper.prototype.getAxis=function(b){if(b in this.model().queryModel.axes){return this.model().queryModel.axes[b]}Saiku.log("Cannot find axis: "+b)};SaikuOlapQueryHelper.prototype.removeFilter=function(i,h){if(h&&i.filters.length>1){var j=-1;for(var f=0,g=i.filters.length;f<g;f++){if(i.filters[f].flavour==h){j=f}}if(j&&j>=0){i.filters.splice(j,0)}}else{i.filters=[]}};SaikuOlapQueryHelper.prototype.includeLevel=function(k,n,j,i){var l=this.getHierarchy(n);if(l){l.levels[j]={name:j}}else{var l={name:n,levels:{}};l.levels[j]={name:j}}var m=this.findAxisForHierarchy(n);if(m){this.moveHierarchy(m.location,k,n,i)}else{var h=this.model().queryModel.axes[k];if(h){if(typeof i!="undefined"&&i>-1&&h.hierarchies.length>i){h.hierarchies.splice(i,0,l);return}h.hierarchies.push(l)}else{Saiku.log("Cannot find axis: "+k+" to include Level: "+j)}}};SaikuOlapQueryHelper.prototype.removeLevel=function(d,c){var d=this.getHierarchy(d);if(d&&d.levels.hasOwnProperty(c)){delete d.levels[c]}};SaikuOlapQueryHelper.prototype.includeMeasure=function(b){this.model().queryModel.details.measures.push(b)};SaikuOlapQueryHelper.prototype.removeMeasure=function(d){var f=this.query.model.queryModel.details.measures;var e=_.findWhere(f,{name:d});if(e&&_.indexOf(f,e)>-1){f=_.without(f,e)}};SaikuOlapQueryHelper.prototype.clearMeasures=function(){this.model().queryModel.details.measures=[]};SaikuOlapQueryHelper.prototype.setMeasures=function(b){this.model().queryModel.details.measures=b};SaikuOlapQueryHelper.prototype.addCalculatedMeasure=function(b){if(b){this.removeCalculatedMeasure(b.name);this.model().queryModel.calculatedMeasures.push(b)}};SaikuOlapQueryHelper.prototype.removeCalculatedMeasure=function(d){var f=this.model().queryModel.calculatedMeasures;var e=_.findWhere(f,{name:d});if(e&&_.indexOf(f,e)>-1){f=_.without(f,e)}};SaikuOlapQueryHelper.prototype.getCalculatedMeasures=function(){var b=this.model().queryModel.calculatedMeasures;if(b){return b}return null};SaikuOlapQueryHelper.prototype.swapAxes=function(){var c=this.model().queryModel.axes;var d=c.ROWS;d.location="COLUMNS";c.ROWS=c.COLUMNS;c.ROWS.location="ROWS";c.COLUMNS=d};SaikuOlapQueryHelper.prototype.nonEmpty=function(b){if(b){this.model().queryModel.axes.ROWS.nonEmpty=true;this.model().queryModel.axes.COLUMNS.nonEmpty=true}else{this.model().queryModel.axes.ROWS.nonEmpty=false;this.model().queryModel.axes.COLUMNS.nonEmpty=false}};var SaikuRendererOptions={mode:null,dataMode:null,htmlObject:null,width:null,height:null};var SaikuRenderer=function(c,d){this._options=_.extend(SaikuRendererOptions,d);this._hasProcessed=false;if(typeof Backbone!=="undefined"){_.extend(this,Backbone.Events)}if(c){this._data=c;this.processData(c,d);this._hasProcessed=true}};SaikuRenderer.prototype.render=function(f,e){var d=null;if(typeof Backbone!=="undefined"){this.trigger("render:start",this)}if(!this.hasProcessedData()){this.processData(f,e)}d=this._render(f,e);if(typeof Backbone!=="undefined"){this.trigger("render:end",this)}return d};SaikuRenderer.prototype.processData=function(c,d){if(typeof Backbone!=="undefined"){this.trigger("processData:start",this)}this._processData(c,d);if(typeof Backbone!=="undefined"){this.trigger("processData:end",this)}};SaikuRenderer.prototype.hasProcessedData=function(){return this._hasProcessed};SaikuRenderer.prototype._render=function(c,d){};SaikuRenderer.prototype._processData=function(c,d){};var SaikuTableRenderer=_.extend(SaikuRenderer,{key:"table"});SaikuTableRenderer.prototype._render=function(g,e){var f=this;if(g){this._data=g}if(e){this._options=_.extend({},SaikuRendererOptions,e)}if(typeof this._data=="undefined"){return}if(this._data!=null&&this._data.error!=null){return}if(this._data==null||(this._data.cellset&&this._data.cellset.length===0)){return}if(this._options.htmlObject){if(f._options.hasOwnProperty("batch")){$(f._options.htmlObject).parent().parent().unbind("scroll")}_.defer(function(a){if(f._options.hasOwnProperty("batch")&&!f._options.hasOwnProperty("batchSize")){f._options.batchSize=1000}var b=f.internalRender(f._data,f._options);$(f._options.htmlObject).html(b);_.defer(function(d){if(f._options.hasOwnProperty("batch")&&f._options.hasBatchResult){var p=0;var c=false;var o=f._options.hasOwnProperty("batchIntervalSize")?f._options.batchIntervalSize:20;var t=f._options.hasOwnProperty("batchIntervalTime")?f._options.batchIntervalTime:20;var s=f._options.batchResult.length;var q=function(){if(!c&&s>0&&p<s){c=true;var j="";var k=p;for(var i=0;p<s&&i<o;i++,p++){j+=f._options.batchResult[p]}if(p>k){$(f._options.htmlObject).append($(j))}c=false}if(p>=s){$(f._options.htmlObject).parent().parent().unbind("scroll")}};var r=_.debounce(q,t);$(f._options.htmlObject).parent().parent().scroll(function(){r()})}});return b})}else{var h=this.internalRender(this._data,f._options);return h}};SaikuTableRenderer.prototype.clear=function(f,d){var e=this;if(this._options.htmlObject&&this._options.hasOwnProperty("batch")){$(e._options.htmlObject).parent().parent().unbind("scroll")}};SaikuTableRenderer.prototype._processData=function(c,d){this._hasProcessed=true};function genTotalDataCells(l,k,r,p,i){var n="";var i=i[ROWS];for(var m=r.length-1;m>=0;m--){if(l==r[m]){var q=i[m][p[m]];for(var o=0;o<q.cells.length;o++){n+='<td class="data total">'+q.cells[o][k].value+"</td>"}p[m]++;if(p[m]<i[m].length){r[m]+=i[m][p[m]].width}}}return n}function genTotalHeaderCells(q,x,w,u,o,p){var s="";for(var r=x;r>=0;r--){if(q==w[r]){var v=o[r][u[r]];var i;if(r==0&&x==1){i="col"}else{if(r==x){i="col_total_corner"}else{if(r==x-1&&v.captions){i="col_total_first"}else{i="col_null"}}}for(var t=0;t<v.cells.length;t++){var m="&nbsp;";if(x==o.length-1){if(v.captions){m=o[r][u[r]].captions[t]}if(r==0&&u[r]==0){if(v.captions){m+="&nbsp;"}else{m=""}m+=(p?"<span class='i18n'>Grand Total</span>":"Grand Total")}}s+='<th class="'+i+'">'+(p?"<div>"+m+"</div>":m)+"</th>"}u[r]++;if(u[r]<o[r].length){w[r]+=o[r][u[r]].width}}}return s}function totalIntersectionCells(o,v,u,s,n){var q="";for(var p=v;p>=0;p--){if(o==u[p]){var t=n[p][s[p]];var i="data total";for(var r=0;r<t.cells.length;r++){var m="&nbsp;";q+='<td class="'+i+'">'+m+"</td>"}s[p]++;if(s[p]<n[p].length){u[p]+=n[p][s[p]].width}}}return q}function genTotalHeaderRowCells(k,D,C,j,H){var B=j[COLUMNS];var A=D[COLUMNS];var m=C[COLUMNS];var E=B.length-2;var y="";for(var v=E;v>=0;v--){if(k==A[v]){for(var z=0;z<B[v][m[v]].cells.length;z++){y+="<tr>";for(var w=0;w<=E;w++){var F;var G="&nbsp;";if(v==0&&w==0){F="row"}else{if(v==w+1){F="row_total_corner"}else{if(v==w&&B[v][m[v]].captions){F="row_total_first"}else{if(v<w+1){F="row_total"}else{F="row_null"}}}}if(w==E){if(B[v][m[v]].captions){G=B[v][m[v]].captions[z]}if(v==0&&m[v]==0){if(B[v][m[v]].captions){G+="&nbsp;"}else{G=""}G+=(H?"<span class='i18n'>Grand Total</span>":"Grand Total")}}y+='<th class="'+F+'">'+(H?"<div>"+G+"</div>":G)+"</th>"}var C={};var D={};for(var i=0;i<j[ROWS].length;i++){C[i]=0;D[i]=j[ROWS][i][C[i]].width}for(var x=0;x<B[v][m[v]].cells[z].length;x++){y+='<td class="data total">'+B[v][m[v]].cells[z][x].value+"</td>";y+=totalIntersectionCells(x+1,j[ROWS].length-1,D,C,j[ROWS])}y+="</tr>"}m[v]++;if(m[v]<B[v].length){A[v]+=B[v][m[v]].width}}}return y}var ROWS="ROWS";var COLUMNS="COLUMNS";function nextParentsDiffer(d,f,e){while(f-->0){if(d[f][e].properties.uniquename!=d[f][e+1].properties.uniquename){return true}}return false}function topParentsDiffer(d,f,e){while(e-->0){if(d[f][e].properties.uniquename!=d[f-1][e].properties.uniquename){return true}}return false}SaikuTableRenderer.prototype.internalRender=function(aW,az){var aR="";var aI="";var aA=aW.cellset;var aJ=aA?aA:[];var aU;var aS;var ah;var a3=false;var aD;var aH,aZ;var aY;var ak=false;var a4=0;var aV=[];var aQ=null;var aF=false;var ai=false,k=false;var al=[];var i=true;if(az){aQ=az.hasOwnProperty("batchSize")?az.batchSize:null;i=az.hasOwnProperty("wrapContent")?az.wrapContent:true}var aT={};aT[COLUMNS]=aW.rowTotalsLists;aT[ROWS]=aW.colTotalsLists;var aC={};var am={};var aB=[ROWS,COLUMNS];for(var aG=0;aG<aB.length;aG++){aC[aB[aG]]=new Array();am[aB[aG]]=new Array()}if(aT[COLUMNS]){for(var aG=0;aG<aT[COLUMNS].length;aG++){am[COLUMNS][aG]=0;aC[COLUMNS][aG]=aT[COLUMNS][aG][am[COLUMNS][aG]].width}}for(var aP=0,aN=aJ.length;aP<aN;aP++){var ag=aP-aW.topOffset;aU=1;aS="";ah=false;aH=false;aZ=false;ai=false;var aq=false;if(aT[ROWS]){for(var aG=0;aG<aT[ROWS].length;aG++){am[ROWS][aG]=0;aC[ROWS][aG]=aT[ROWS][aG][am[ROWS][aG]].width}}aI="<tr>";if(aP===0){aI="<thead>"+aI}for(var aX=0,a1=aJ[aP].length;aX<a1;aX++){var af=aX-aW.leftOffset;var a2=aA[aP][aX];if(a2.type==="COLUMN_HEADER"){ai=true}if(a2.type==="COLUMN_HEADER"&&a2.value==="null"&&(aD==null||aX<aD)){aI+='<th class="all_null">&nbsp;</th>'}else{if(a2.type==="COLUMN_HEADER"){if(aD==null){aD=aX}if(aJ[aP].length==aX+1){aH=true}else{aY=aA[aP][aX+1]}if(aH){if(a2.value=="null"){aI+='<th class="col_null">&nbsp;</th>'}else{if(aT[ROWS]){aU=aT[ROWS][aP+1][am[ROWS][aP+1]].span}aI+='<th class="col" style="text-align: center;" colspan="'+aU+'" title="'+a2.value+'">'+(i?'<div rel="'+aP+":"+aX+'">'+a2.value+"</div>":a2.value)+"</th>"}}else{var aE=(aX>1&&aP>1&&!ah&&aX>aD)?aA[aP-1][aX+1].value!=aA[aP-1][aX].value||aA[aP-1][aX+1].properties.uniquename!=aA[aP-1][aX].properties.uniquename:false;var an=aU>999?true:false;if(a2.value!=aY.value||nextParentsDiffer(aA,aP,aX)||ah||aE||an){if(a2.value=="null"){aI+='<th class="col_null" colspan="'+aU+'">&nbsp;</th>'}else{if(aT[ROWS]){aU=aT[ROWS][aP+1][am[ROWS][aP+1]].span}aI+='<th class="col" style="text-align: center;" colspan="'+(aU==0?1:aU)+'" title="'+a2.value+'">'+(i?'<div rel="'+aP+":"+aX+'">'+a2.value+"</div>":a2.value)+"</th>"}aU=1}else{aU++}}if(aT[ROWS]){aI+=genTotalHeaderCells(aX-aW.leftOffset+1,aP+1,aC[ROWS],am[ROWS],aT[ROWS],i)}}else{if(a2.type==="ROW_HEADER"&&a2.value==="null"){aI+='<th class="row_null">&nbsp;</th>'}else{if(a2.type==="ROW_HEADER"){if(a4==aX){ah=true}else{aY=aA[aP][aX+1]}var ap=aA[aP-1];var aO=!aq&&!ah&&(aX==0||!topParentsDiffer(aA,aP,aX))&&a2.value===ap[aX].value;aq=!aO;var aj=(aO?"<div>&nbsp;</div>":'<div rel="'+aP+":"+aX+'">'+a2.value+"</div>");if(!i){aj=(aO?"&nbsp;":a2.value)}var ar="";var ao=(aO?"row_null":"row");var aL=0;if(!ah&&(typeof aY=="undefined"||aY.value==="null")){aL=1;var aM=a2.properties.dimension;var a0=a2.properties.level;var ay=(aM in aV?aV[aM].length-aV[aM].indexOf(a0):1);for(var ae=aX+1;aL<ay&&ae<=(a4+1)&&aA[aP][ae]!=="null";ae++){aL=ae-aX}aX=aX+aL-1}aI+='<th class="'+ao+'" '+(aL>0?' colspan="'+aL+'"':"")+ar+">"+aj+"</th>"}else{if(a2.type==="ROW_HEADER_HEADER"){aI+='<th class="row_header">'+(i?"<div>"+a2.value+"</div>":a2.value)+"</th>";ah=true;ak=true;a4=aX;if(a2.properties.hasOwnProperty("dimension")){var aM=a2.properties.dimension;if(!(aM in aV)){aV[aM]=[]}aV[aM].push(a2.properties.level)}}else{if(a2.type==="DATA_CELL"){aF=true;var av="";var aw=a2.value;var at="";if(a2.properties.hasOwnProperty("image")){var au=a2.properties.hasOwnProperty("image_height")?" height='"+a2.properties.image_height+"'":"";var ax=a2.properties.hasOwnProperty("image_width")?" width='"+a2.properties.image_width+"'":"";aw="<img "+au+" "+ax+" style='padding-left: 5px' src='"+a2.properties.image+"' border='0'>"}if(a2.properties.hasOwnProperty("style")){av=" style='background-color: "+a2.properties.style+"' "}if(a2.properties.hasOwnProperty("link")){aw="<a target='__blank' href='"+a2.properties.link+"'>"+aw+"</a>"}if(a2.properties.hasOwnProperty("arrow")){at="<img height='10' width='10' style='padding-left: 5px' src='./images/arrow-"+a2.properties.arrow+".gif' border='0'>"}aI+='<td class="data" '+av+">"+(i?'<div class="datadiv" alt="'+a2.properties.raw+'" rel="'+a2.properties.position+'">':"")+aw+at+(i?"</div>":"")+"</td>";if(aT[ROWS]){aI+=genTotalDataCells(af+1,ag,aC[ROWS],am[ROWS],aT,i)}}}}}}}}aI+="</tr>";var aK="";if(aT[COLUMNS]&&ag>=0){aK+=genTotalHeaderRowCells(ag+1,aC,am,aT,i)}if(aF&&aQ){if(aP<=aQ){if(!ai&&!k){aR+="</thead><tbody>";k=true}aR+=aI;if(aK.length>0){aR+=aK}}else{al.push(aI);if(aK.length>0){al.push(aK)}}}else{if(!ai&&!k){aR+="</thead><tbody>";k=true}aR+=aI;if(aK.length>0){aR+=aK}}}if(az){az.batchResult=al;az.hasBatchResult=al.length>0}return"<table>"+aR+"</tbody></table>"};var SaikuChartRenderer=function(g,e){this.rawdata=g;this.cccOptions={};this.data=null,this.hasProcessed=false;this.hasRendered=false;if(!e&&!e.hasOwnProperty("htmlObject")){throw ("You need to supply a html object in the options for the SaikuChartRenderer!")}this.el=$(e.htmlObject);this.id=_.uniqueId("chart_");$(this.el).html('<div class="canvas_wrapper" style="display:none;"><div id="canvas_'+this.id+'"></div></div>');this.zoom=e.zoom;if(e.zoom){var f=this;var h="<span style='float:left;' class='zoombuttons'><a href='#' class='button rerender' title='Re-render chart'></a><a href='#' class='button zoomout' style='display:none;' title='Zoom back out'></a></span>";$(h).prependTo($(this.el).find(".canvas_wrapper"));$(this.el).find(".zoomout").on("click",function(a){a.preventDefault();f.zoomout()});$(this.el).find(".zoomin").on("click",function(a){a.preventDefault();f.zoomin()});$(this.el).find(".rerender").on("click",function(a){a.preventDefault();$(f.el).find(".zoomout").hide();f.switch_chart(f.type)})}if(e.chartDefinition){this.chartDefinition=e.chartDefinition}this.cccOptions.canvas="canvas_"+this.id;this.data=null;this.adjustSizeTo=null;if(e.adjustSizeTo){this.adjustSizeTo=e.adjustSizeTo}else{this.adjustSizeTo=e.htmlObject}if(this.rawdata){if(this.type=="sunburst"){this.process_data_tree({data:this.rawdata})}else{this.process_data_tree({data:this.rawdata},true,true)}}if(e.mode){this.switch_chart(e.mode)}else{this.switch_chart("stackedBar")}this.adjust()};SaikuChartRenderer.prototype.adjust=function(){var e=this;var f=function(){if(e.hasRendered&&$(e.el).is(":visible")){e.switch_chart(e.type)}};var d=_.debounce(f,300);$(window).resize(function(){$(e.el).find(".canvas_wrapper").fadeOut(150);d()})};SaikuChartRenderer.prototype.zoomin=function(){$(this.el).find(".canvas_wrapper").hide();var d=this.chart.root;var c=d.data;c.datums(null,{selected:false}).each(function(a){a.setVisible(false)});c.clearSelected();d.render(true,true,false);this.render_chart_element()},SaikuChartRenderer.prototype.zoomout=function(){var j=this.chart.root;var i=j.data;var h=j.keptVisibleDatumSet;if(h==null||h.length==0){$(this.el).find(".zoomout").hide()}else{if(h.length==1){$(this.el).find(".zoomout").hide();j.keptVisibleDatumSet=[];pvc.data.Data.setVisible(i.datums(null,{visible:false}),true)}else{if(h.length>1){j.keptVisibleDatumSet.splice(h.length-1,1);var g=i.datums(null,{visible:false}).array();var f=j.keptVisibleDatumSet[h.length-1];_.intersection(f,g).forEach(function(a){a.setVisible(true)})}}}j.render(true,true,false)};SaikuChartRenderer.prototype.render=function(){_.delay(this.render_chart_element,0,this)};SaikuChartRenderer.prototype.switch_chart=function(e){var d={stackedBar:{type:"BarChart",stacked:true},bar:{type:"BarChart"},multiplebar:{type:"BarChart",multiChartIndexes:[1],dataMeasuresInColumns:true,orientation:"vertical",smallTitlePosition:"top",multiChartMax:30,multiChartColumnsMax:Math.floor(this.cccOptions.width/200),smallWidth:200,smallHeight:150},line:{type:"LineChart"},pie:{type:"PieChart",multiChartIndexes:[0]},heatgrid:{type:"HeatGridChart"},stackedBar100:{type:"NormalizedBarChart"},area:{type:"StackedAreaChart"},dot:{type:"DotChart"},waterfall:{type:"WaterfallChart"},treemap:{type:"TreemapChart"},sunburst:{type:"SunburstChart"}};if(e=="suanburst"){$(this.el).find(".zoombuttons a").hide();this.type=e;this.sunburst();if(this.hasProcessed){this.render()}}else{if(d.hasOwnProperty(e)){$(this.el).find(".zoombuttons a").hide();this.type=e;var f=d[e];this.cccOptions=this.getQuickOptions(f);this.define_chart();if(this.hasProcessed){this.render()}}else{alert("Do not support chart type: '"+e+"'")}}};SaikuChartRenderer.prototype.sunburst=function(){this.type="sunburst";var o=this.process_data_tree({data:this.rawdata});var j=this.getQuickOptions({});function l(a){return a.parentNode?(l(a.parentNode)+"."+a.nodeName):a.nodeName}var k="",r=pv.dom(o).nodes();var m={delayIn:200,delayOut:80,offset:2,html:true,gravity:"nw",fade:false,followMouse:true,corners:true,arrow:false,opacity:1};var p=pv.colors(j.colors).by(function(a){return a.parentNode&&a.parentNode.nodeName});var q=new pv.Panel().width(j.width).height(j.height).canvas(j.canvas);var n=q.add(pv.Layout.Partition.Fill).nodes(r).size(function(a){return a.nodeValue}).order("descending").orient("radial");n.node.add(pv.Wedge).fillStyle(pv.colors(j.colors).by(function(a){return a.parentNode&&a.parentNode.nodeName})).visible(function(a){return a.depth>0}).strokeStyle("#000").lineWidth(0.5).text(function(a){var b="";if(typeof a.nodeValue!="undefined"){b=" : "+a.nodeValue}return(a.nodeName+b)}).cursor("pointer").events("all").event("mousemove",pv.Behavior.tipsy(m));n.label.add(pv.Label).visible(function(a){return a.angle*a.outerRadius>=6});this.chart=q};SaikuChartRenderer.prototype.cccOptionsDefault={Base:{animate:false,selectable:true,valuesVisible:false,legend:true,legendPosition:"top",legendAlign:"right",compatVersion:2,legendSizeMax:"30%",axisSizeMax:"40%",plotFrameVisible:false,orthoAxisMinorTicks:false,colors:["#1f77b4","#aec7e8","#ff7f0e","#ffbb78","#2ca02c","#98df8a","#d62728","#ff9896","#9467bd","#c5b0d5","#8c564b","#c49c94","#e377c2","#f7b6d2","#7f7f7f","#c7c7c7","#bcbd22","#dbdb8d","#17becf","#9edae5"]},HeatGridChart:{orientation:"horizontal",useShapes:true,shape:"circle",nullShape:"cross",colorNormByCategory:false,sizeRole:"value",legendPosition:"right",legend:true,hoverable:true,axisComposite:true,colors:["red","yellow","lightgreen","darkgreen"],yAxisSize:"20%"},WaterfallChart:{orientation:"horizontal"},PieChart:{multiChartColumnsMax:3,multiChartMax:30,smallTitleFont:"bold 14px sans-serif",valuesVisible:true,valuesMask:"{value.percent}",explodedSliceRadius:"10%",extensionPoints:{slice_innerRadiusEx:"40%",slice_offsetRadius:function(b){return b.isSelected()?"10%":0}},clickable:true},LineChart:{extensionPoints:{area_interpolate:"monotone",line_interpolate:"monotone"}},StackedAreaChart:{extensionPoints:{area_interpolate:"monotone",line_interpolate:"monotone"}},TreemapChart:{legendPosition:"right",multiChartIndexes:0,extensionPoints:{leaf_lineWidth:2},layoutMode:"slice-and-dice",valuesVisible:true},SunburstChart:{valuesVisible:false,hoverable:false,selectable:true,clickable:false,multiChartIndexes:[0],multiChartMax:30}};SaikuChartRenderer.prototype.getQuickOptions=function(g){var k=(g&&g.type)||"BarChart";var h=_.extend({type:k,canvas:"canvas_"+this.id},this.cccOptionsDefault.Base,this.cccOptionsDefault[k],g);if(this.adjustSizeTo){var j=$(this.adjustSizeTo);if(j&&j.length>0){var l=j.width()-40;var i=j.height()-40;if(l>0){h.width=l}if(i>0){h.height=i}}}if(this.data!=null&&this.data.resultset.length>5){if(h.type==="HeatGridChart"){}else{if(h.orientation!=="horizontal"){h.extensionPoints=_.extend(Object.create(h.extensionPoints||{}),{xAxisLabel_textAngle:-Math.PI/2,xAxisLabel_textAlign:"right",xAxisLabel_textBaseline:"middle"})}}}return h};SaikuChartRenderer.prototype.define_chart=function(r){if(!this.hasProcessed){this.process_data_tree({data:this.rawdata},true,true)}var m=this;var q=(this.adjustSizeTo?$(this.adjustSizeTo):$(this.el));var s=(this.data!=null&&this.data.height<80&&this.data.width<80);var o=(this.data!=null&&this.data.height<300&&this.data.width<300);var t=(!s&&!o);var v=false;var w=s;var n=q.width()-40;var p=q.height()-40;var u=_.clone(this.cccOptions);if(r&&r.width){n=r.width}if(r&&r.height){p=r.height}if(n>0){u.width=n}if(p>0){u.height=p}if(t){if(u.hasOwnProperty("extensionPoints")&&u.extensionPoints.hasOwnProperty("line_interpolate")){delete u.extensionPoints.line_interpolate}if(u.hasOwnProperty("extensionPoints")&&u.extensionPoints.hasOwnProperty("area_interpolate")){delete u.extensionPoints.area_interpolate}}var x={legend:{scenes:{item:{execute:function(){var b=this.chart();if(!b.hasOwnProperty("keptVisibleDatumSet")){b.keptVisibleDatumSet=[]}var c=b.keptVisibleDatumSet.length>0?b.keptVisibleDatumSet[b.keptVisibleDatumSet.length-1]:[];var a=c.length>0;if(a){_.intersection(this.datums().array(),c).forEach(function(d){d.toggleVisible()})}else{pvc.data.Data.toggleVisible(this.datums())}this.chart().render(true,true,false)}}}},userSelectionAction:function(e){if(e.length==0){return[]}var b=m.chart.root;var c=b.data;var g=this.chart;if(!g.hasOwnProperty("keptVisibleDatumSet")){g.keptVisibleDatumSet=[]}if(c.datums().count()>1500){pvc.data.Data.setSelected(e,true)}else{if(c.datums(null,{visible:true}).count()==c.datums().count()){$(m.el).find(".zoomout, .rerender").show();var i=c.datums().array();_.each(_.difference(i,e),function(j){j.setVisible(false)});g.keptVisibleDatumSet=[];g.keptVisibleDatumSet.push(e)}else{var f=g.keptVisibleDatumSet.length>0?g.keptVisibleDatumSet[g.keptVisibleDatumSet.length-1]:[];var h=c.datums(null,{visible:true}).array();var d=f;if(h.length<f.length){d=h;g.keptVisibleDatumSet.push(h)}var a=[];_.each(_.difference(h,e),function(j){j.setVisible(false)});_.each(_.intersection(h,e),function(j){a.push(j)});if(a.length>0){g.keptVisibleDatumSet.push(a)}}}b.render(true,true,false);return[]}};u=_.extend(u,{hoverable:w,animate:v},this.chartDefinition);if(m.zoom){u=_.extend(u,x)}if(u.type=="TreemapChart"){u.legend.scenes.item.labelText=function(){var a="";var c=this.group;if(c){var b=c.depth;switch(b){case 0:return"";case 1:break;case 2:a=" └ ";break;default:a=new Array(2*(b-2)+1).join(" ")+" └ "}}return a+this.base()}}this.chart=new pvc[u.type](u);this.chart.setData(this.data,{crosstabMode:true,seriesInRows:false})};SaikuChartRenderer.prototype.render_chart_element=function(n){var e=n||this;var l=(e.data!=null&&e.data.height<80&&e.data.width<80);var j=(e.data!=null&&e.data.height<300&&e.data.width<300);var m=(!l&&!j);var i=false;if(e.chart.options&&e.chart.options.animate){i=true}if(!i||$(e.el).find(".canvas_wrapper").is(":visible")){$(e.el).find(".canvas_wrapper").hide()}try{if(i){$(e.el).find(".canvas_wrapper").show()}e.chart.render();e.hasRendered=true}catch(k){$("#canvas_"+e.id).text("Could not render chart"+k)}if(e.chart.options&&e.chart.options.animate){return false}if(isIE||m){$(e.el).find(".canvas_wrapper").show()}else{$(e.el).find(".canvas_wrapper").fadeIn(400)}return false};SaikuChartRenderer.prototype.process_data_tree=function(ag,P,M){var I=this;var N={};if(P){N.resultset=[];N.metadata=[];N.height=0;N.width=0}var J=N;if(typeof ag=="undefined"||typeof ag.data=="undefined"){return}if(ag.data!=null&&ag.data.error!=null){return}if(ag.data==null||(ag.data.cellset&&ag.data.cellset.length===0)){return}var G=ag.data.cellset;if(G&&G.length>0){var ae=0;var al=0;var S=false;for(var Y=0,Z=G.length;al==0&&Y<Z;Y++){for(var aj=0,ah=G[Y].length;aj<ah;aj++){if(!S){while(G[Y][aj].type=="COLUMN_HEADER"&&G[Y][aj].value=="null"){Y++}}S=true;if(G[Y][aj].type=="ROW_HEADER_HEADER"){while(G[Y][aj].type=="ROW_HEADER_HEADER"){if(P){N.metadata.push({colIndex:aj,colType:"String",colName:G[Y][aj].value})}aj++}ae=aj-1}if(G[Y][aj].type=="COLUMN_HEADER"){var Q=0;var X=[];while(Q<=Y){if(G[Q][aj].value!=="null"){X.push(G[Q][aj].value)}Q++}if(P){N.metadata.push({colIndex:aj,colType:"Numeric",colName:X.join(" ~ ")})}al=Y+1}}}var O={};var R=[];for(var K=0;K<=ae;K++){R.push(null)}for(var Y=al,Z=G.length;Y<Z;Y++){if(G[Y][0].value!==""){var af=[];var aa=[];var U=null;var ab=null;for(var K=0;K<=ae;K++){if(G[Y]&&G[Y][K].value==="null"){J=N;var W=0;for(;W<ae&&G[Y][W].value==="null";W++){J=J[R[W]]}if(W>K){K=W}}if(G[Y]&&G[Y][K].value!=="null"){if(K==0){for(var ac=0;ac<=ae;ac++){R[ac]=null}}if(typeof J=="number"){U[ab]={};J=U[ab]}ab=G[Y][K].value;R[K]=ab;if(!J.hasOwnProperty(ab)){J[ab]={}}U=J;J=J[ab]}}aa=_.clone(R);for(var ad=ae+1,T=G[Y].length;ad<T;ad++){var ak=G[Y][ad];var H=ak.value||0;var V=(H!=0);var L=ak.properties.raw;if(L&&L!=="null"){H=parseFloat(L)}else{if(typeof(ak.value)!=="number"&&parseFloat(ak.value.replace(/[^a-zA-Z 0-9.]+/g,""))){H=parseFloat(ak.value.replace(/[^a-zA-Z 0-9.]+/g,""));V=false}}if(H>0&&V){H=ak.value&&ak.value.indexOf("%")>=0?H*100:H}af.push(H);aa.push({f:ak.value,v:H})}if(P){N.resultset.push(aa)}var ai=_.reduce(af,function(b,a){return b+a},0);ab=(ab==null?"null":ab);U[ab]=ai;J=N}}if(M){I.rawdata=ag.data;I.data=N;I.hasProcessed=true;I.data.height=I.data.resultset.length}return N}else{$(I.el).find(".canvas_wrapper").text("No results").show()}};var Cube=Backbone.Model.extend({initialize:function(b){this.url=Saiku.session.username+"/discover/"+b.key+"/metadata"},parse:function(e){var h=_.template($("#template-dimensions").html(),{dimensions:e.dimensions});var g=_.template($("#template-measures").html(),{measures:e.measures});var f=_.template($("#template-attributes").html(),{cube:e});this.set({template_measures:g,template_dimensions:h,template_attributes:$(f).html(),data:e});typeof localStorage!=="undefined"&&localStorage&&localStorage.setItem("cube."+this.get("key"),JSON.stringify(this));return e}});var DimensionList=Backbone.View.extend({events:{"click span":"select","click a":"select","click .parent_dimension ul li a.level":"select_dimension","click .measure":"select_measure","click .addMeasure":"measure_dialog"},initialize:function(b){_.bindAll(this,"render","load_dimension","select_dimension");this.workspace=b.workspace;this.cube=b.cube},load_dimension:function(){this.template=this.cube.get("template_attributes");this.render_attributes();this.workspace.sync_query()},render:function(){if(this.cube&&this.cube.has("template_attributes")){this.load_dimension()}else{if(!this.cube){$(this.el).html("Could not load attributes. Please log out and log in again.")}else{var b=_.template($("#template-attributes").html());$(this.el).html(b);$(this.el).find(".loading").removeClass("hide");this.workspace.bind("cube:loaded",this.load_dimension)}}return this},render_attributes:function(){var b=this;$(this.el).html(this.template);if(isIE&&isIE<=8){$(this.el).show()}else{$(this.el).fadeTo(500,1)}$(this.el).find(".addMeasure, .calculated_measures").show();$(this.el).find(".measure").parent("li").draggable({cancel:".not-draggable",connectToSortable:$(this.workspace.el).find(".fields_list_body.details ul.connectable"),helper:"clone",placeholder:"placeholder",opacity:0.6,tolerance:"touch",containment:$(b.workspace.el),cursorAt:{top:10,left:35}});$(this.el).find(".level").parent("li").draggable({cancel:".not-draggable, .hierarchy",connectToSortable:$(this.workspace.el).find(".fields_list_body.columns > ul.connectable, .fields_list_body.rows > ul.connectable, .fields_list_body.filter > ul.connectable"),containment:$(b.workspace.el),helper:function(l,k){var j=$(l.target).hasClass("d_level")?$(l.target):$(l.target).parent();var a=j.find("a").attr("hierarchy");var h=j.find("a").attr("level");var m=j.parent().clone().removeClass("d_hierarchy").addClass("hierarchy");m.find('li a[hierarchy="'+a+'"]').parent().hide();m.find('li a[level="'+h+'"]').parent().show();var n=$('<li class="selection"></li>');n.append(m);return n},placeholder:"placeholder",opacity:0.6,tolerance:"touch",cursorAt:{top:10,left:85}})},select:function(c){var d=$(c.target).hasClass("root")?$(c.target):$(c.target).parent().find("span");if(d.hasClass("root")){d.find("a").toggleClass("folder_collapsed").toggleClass("folder_expand");d.toggleClass("collapsed").toggleClass("expand");d.parents("li").find("ul").children("li").toggle()}return false},select_dimension:function(o,m){if(this.workspace.query.model.type!="QUERYMODEL"){return}if($(o.target).parent().hasClass("ui-state-disabled")){o.preventDefault();o.stopPropagation();return}var i=$(o.target).attr("hierarchy");var p=$(o.target).parent().parent().attr("hierarchycaption");var k=$(o.target).attr("level");var l="ROWS";if($(this.workspace.el).find(".workspace_fields ul.hierarchy[hierarchy='"+i+"']").length>0){var n=$(this.workspace.el).find(".workspace_fields ul[hierarchy='"+i+"'] a[level='"+k+"']").parent().show();l=n.parents(".fields_list_body").hasClass("rows")?"ROWS":"COLUMNS"}else{var j=$(this.workspace.el).find(".workspace_fields .fields_list[title='ROWS'] ul.hierarchy").length>0?$(this.workspace.el).find(".workspace_fields .fields_list[title='COLUMNS'] ul.connectable"):$(this.workspace.el).find(".workspace_fields .fields_list[title='ROWS'] ul.connectable");l=j.parents(".fields_list").attr("title")}this.workspace.query.helper.includeLevel(l,i,k);this.workspace.sync_query();this.workspace.query.run();o.preventDefault();return false},select_measure:function(h,g){if($(h.target).parent().hasClass("ui-state-disabled")){return}var f=$(h.target).parent().clone();var e={name:f.find("a").attr("measure"),type:f.find("a").attr("type")};this.workspace.query.helper.includeMeasure(e);this.workspace.sync_query();this.workspace.query.run();h.preventDefault();return false},measure_dialog:function(d,c){(new MeasuresModal({workspace:this.workspace,measure:null})).render().open()}});var Toolbar=Backbone.View.extend({tagName:"div",events:{"click a":"call"},template:function(){return _.template($("#template-toolbar").html())(this)},initialize:function(){this.render()},render:function(){$(this.el).attr("id","toolbar").html(this.template());Saiku.events.trigger("toolbar:render",{toolbar:this});return this},call:function(d){var e=$(d.target);var f=e.attr("href").replace("#","");if(this[f]){this[f](d)}d.preventDefault()},new_query:function(){Saiku.tabs.add(new Workspace());return false},open_query:function(){var b=_.detect(Saiku.tabs._tabs,function(a){return a.content instanceof OpenQuery});if(b){b.select()}else{Saiku.tabs.add(new OpenQuery())}return false},logout:function(){Saiku.session.logout()},about:function(){(new AboutModal).render().open();return false},issue_tracker:function(){window.open("https://github.com/OSBI/saiku/issues/new");return false}});var Upgrade=Backbone.View.extend({tagName:"div",events:{"click .upgradeheader":"call"},template:function(){var b=$("#template-upgrade").html()||"";return _.template(b)()},initialize:function(){},render:function(){if(!Settings.UPGRADE){return this}var e=Saiku.session.upgradeTimeout;var f=false;var g=true;if(typeof localStorage!=="undefined"&&localStorage){if(localStorage.getItem("saiku.upgradeTimeout")!==null){e=localStorage.getItem("saiku.upgradeTimeout")}f=true}var h=(new Date()).getTime();if(!e||(h-e)>(10*60*1000)){$(this.el).html(this.template());Saiku.session.upgradeTimeout=h;if(typeof localStorage!=="undefined"&&localStorage){localStorage.setItem("saiku.upgradeTimeout",h)}}return this},call:function(b){$(".upgradeheader").slideUp("slow")}});var Modal=Backbone.View.extend({tagName:"div",className:"dialog",type:"modal",message:"Put content here",options:{autoOpen:false,modal:true,title:"Modal dialog",resizable:false,draggable:true},events:{"click a":"call"},buttons:[{text:"OK",method:"close"}],template:function(){return _.template("<div class='dialog_icon'></div><div class='dialog_body'><%= message %></div><div class='dialog_footer'><% _.each(buttons, function(button) { %><a class='form_button i18n' href='#<%= button.method %>'>&nbsp;<%= button.text %>&nbsp;</a><% }); %></div>")(this)},initialize:function(b){_.extend(this,b);_.bindAll(this,"call");_.extend(this,Backbone.Events)},render:function(){$(this.el).html(this.template()).addClass("dialog_"+this.type).dialog(this.options);var b=$(".ui-dialog-title");b.html(this.options.title);b.addClass("i18n");Saiku.i18n.translate();return this},call:function(d){var c=d.target.hash.replace("#","");if(!$(d.target).hasClass("disabled_toolbar")&&this[c]){this[c](d)}return false},open:function(){$(this.el).dialog("open");this.trigger("open",{modal:this});return this},close:function(){$(this.el).dialog("destroy").remove();$(this.el).remove();return false}});var MDXModal=Modal.extend({type:"mdx",initialize:function(b){this.options.title="MDX";this.message=_.template("<textarea><%= mdx %></textarea>")(b);this.bind("open",function(){var a=this;$(a.el).parents(".ui-dialog").css({width:"550px"})})}});var SelectionsModal=Modal.extend({type:"selections",buttons:[{text:"OK",method:"save"},{text:"Cancel",method:"close"}],events:{"click a":"call","click .search_term":"search_members","click .clear_search":"clear_search","change #show_unique":"show_unique_action","change #use_result":"use_result_action","dblclick .selection_options li.option_value label":"click_move_selection","click li.all_options":"click_all_member_selection","change #show_totals":"show_totals_action"},show_unique_option:false,use_result_option:Settings.MEMBERS_FROM_RESULT,show_totals_option:"",members_limit:Settings.MEMBERS_LIMIT,members_search_limit:Settings.MEMBERS_SEARCH_LIMIT,members_search_server:false,initialize:function(n){var p=this;_.extend(this,n);this.options.title="<span class='i18n'>Selections for</span> "+this.name;this.message="Fetching members...";this.query=n.workspace.query;this.selected_members=[];this.available_members=[];_.bindAll(this,"fetch_members","populate","finished","get_members","use_result_action","show_totals_action");this.axis="undefined";if(n.axis){this.axis=n.axis;if(n.axis=="FILTER"){this.use_result_option=false}}else{if(n.target.parents(".fields_list_body").hasClass("rows")){this.axis="ROWS"}if(n.target.parents(".fields_list_body").hasClass("columns")){this.axis="COLUMNS"}if(n.target.parents(".fields_list_body").hasClass("filter")){this.axis="FILTER";this.use_result_option=false}}this.bind("open",this.post_render);this.render();$(this.el).parent().find(".ui-dialog-titlebar-close").bind("click",this.finished);this.member=new Member({},{cube:n.workspace.selected_cube,dimension:n.key});$(this.el).find(".dialog_body").html(_.template($("#template-selections").html())(this));var m=this.member.hierarchy;var k=this.member.level;var o=this.workspace.query.helper.getHierarchy(m);var l=null;if(o&&o.levels.hasOwnProperty(k)){l=o.levels[k]}if(Settings.ALLOW_PARAMETERS){if(l){var i=l.selection?l.selection.parameterName:null;if(i){$(this.el).find("input.parameter").val(i)}}$(this.el).find(".parameter").removeClass("hide")}var j=$(this.el).find("#show_totals");j.val("");if(_.size(o.levels)>1&&l&&l.hasOwnProperty("aggregators")&&l.aggregators){if(l.aggregators.length>0){this.show_totals_option=l.aggregators[0]}j.removeAttr("disabled")}else{j.attr("disabled",true);this.show_totals_option=""}j.val(this.show_totals_option);$(this.el).find("#use_result").attr("checked",this.use_result_option);$(this.el).find(".search_limit").text(this.members_search_limit);$(this.el).find(".members_limit").text(this.members_limit);this.get_members()},show_totals_action:function(b){this.show_totals_option=$(b.target).val()},get_members:function(){var e=this;var f="/result/metadata/hierarchies/"+encodeURIComponent(this.member.hierarchy)+"/levels/"+encodeURIComponent(this.member.level);this.search_path=f;var d='<span class="processing_image">&nbsp;&nbsp;</span> <span class="i18n">'+e.message+"</span> ";e.workspace.block(d);this.workspace.query.action.get(f,{success:this.fetch_members,error:function(){e.workspace.unblock()},data:{result:this.use_result_option,searchlimit:this.members_limit}})},clear_search:function(){$(this.el).find(".filterbox").val("");this.get_members()},search_members:function(){var e=this;var f=$(this.el).find(".filterbox").val();if(!f){return false}var d='<span class="processing_image">&nbsp;&nbsp;</span> <span class="i18n">Searching for members matching:</span> '+f;e.workspace.block(d);e.workspace.query.action.get(e.search_path,{async:false,success:function(b,a){if(a&&a.length>0){e.available_members=a}e.populate()},error:function(){e.workspace.unblock()},data:{search:f,searchlimit:e.members_search_limit}})},fetch_members:function(f,d){var e=this;if(d&&d.length>0){this.available_members=d}this.populate()},populate:function(s,x){var j=this;j.workspace.unblock();this.members_search_server=(this.available_members.length>=this.members_limit||this.available_members.length==0);j.show_unique_option=false;$(this.el).find(".options #show_unique").attr("checked",false);$(this.el).find(".items_size").text(this.available_members.length);if(this.members_search_server){$(this.el).find(".warning").text("More items available than listed. Pre-Filter on server.")}else{$(this.el).find(".warning").text("")}var w=j.member.hierarchy;var z=j.member.level;var p=j.workspace.query.helper.getHierarchy(w);if(p&&p.levels.hasOwnProperty(z)){this.selected_members=p.levels[z].selection?p.levels[z].selection.members:[]}var t=[];for(var v=0,r=this.selected_members.length;v<r;v++){var u=this.selected_members[v];t.push(u.caption)}if($(this.el).find(".used_selections .selection_options li.option_value").length==0){var q=$(this.el).find(".used_selections .selection_options");q.empty();var o=_.template($("#template-selections-options").html())({options:this.selected_members});$(q).html(o)}this.available_members=_.select(this.available_members,function(a){return t.indexOf(a.caption)===-1});if(this.available_members.length>0){var y=$(this.el).find(".available_selections .selection_options");y.empty();var o=_.template($("#template-selections-options").html())({options:this.available_members});$(y).html(o)}if($(j.el).find(".selection_options.ui-selectable").length>0){$(j.el).find(".selection_options").selectable("destroy")}$(j.el).find(".selection_options").selectable({distance:20,filter:"li",stop:function(a,b){$(j.el).find(".selection_options li.ui-selected input").each(function(d,c){if(c&&c.hasAttribute("checked")){c.checked=true}else{$(c).attr("checked",true)}$(c).parents(".selection_options").find("li.all_options input").prop("checked",true)});$(j.el).find(".selection_options li.ui-selected").removeClass("ui-selected")}});$(this.el).find(".filterbox").autocomplete({minLength:1,delay:200,appendTo:".autocomplete",source:function(c,e){var b=j.available_members;var d=j.show_unique_option==false?"caption":"name";var a=$.map(b,function(g){if(g[d].toLowerCase().indexOf(c.term.toLowerCase())>-1){var h=j.show_unique_option==false?g.caption:g.uniqueName;var f=j.show_unique_option==false?g.uniqueName:g.caption;return{label:h,value:f}}});e(a)},select:function(d,b){var c=encodeURIComponent(b.item.value);var g=b.item.label;var a=j.show_unique_option==false?b.item.value:b.item.label;var f=j.show_unique_option==false?b.item.label:b.item.value;$(j.el).find('.available_selections .selection_options input[value="'+encodeURIComponent(a)+'"]').parent().remove();$(j.el).find('.used_selections .selection_options input[value="'+encodeURIComponent(a)+'"]').parent().remove();var e='<li class="option_value"><input type="checkbox" class="check_option" value="'+encodeURIComponent(a)+'" label="'+encodeURIComponent(f)+'">'+g+"</input></li>";$(e).appendTo($(j.el).find(".used_selections .selection_options ul"));$(j.el).find(".filterbox").val("");b.item.value=""},close:function(a,b){},open:function(a,b){}});$(this.el).find(".filterbox").autocomplete("enable");Saiku.i18n.translate();Saiku.ui.unblock()},post_render:function(e){var f=($(window).width()-1000)/2;var d=$(window).width()<1040?$(window).width():1040;$(e.modal.el).parents(".ui-dialog").css({width:d,left:"inherit",margin:"0",height:490}).offset({left:f});$("#filter_selections").attr("disabled",false);$(this.el).find("a[href=#save]").focus();$(this.el).find("a[href=#save]").blur()},move_selection:function(j){j.preventDefault();var i=$(j.target).attr("id");var h=i.indexOf("add")!==-1?$(this.el).find(".used_selections .selection_options ul"):$(this.el).find(".available_selections .selection_options ul");var f=i.indexOf("add")!==-1?$(this.el).find(".available_selections .selection_options ul"):$(this.el).find(".used_selections .selection_options ul");var g=i.indexOf("all")!==-1?f.find("li.option_value input").parent():f.find("li.option_value input:checked").parent();g.detach().appendTo(h);$(this.el).find(".selection_options ul li.option_value input:checked").prop("checked",false);$(this.el).find(".selection_options li.all_options input").prop("checked",false)},updown_selection:function(b){b.preventDefault();return false},click_all_member_selection:function(d,f){var e=$(d.currentTarget).find("input").is(":checked");if(!e){$(d.currentTarget).parent().find("li.option_value input").removeAttr("checked")}else{$(d.currentTarget).parent().find("li.option_value input").prop("checked",true)}},click_move_selection:function(e,d){e.preventDefault();var f=($(e.target).parent().parent().parent().parent().hasClass("used_selections"))?".available_selections":".used_selections";$(e.target).parent().appendTo($(this.el).find(f+" .selection_options ul"))},show_unique_action:function(){var b=this;this.show_unique_option=!this.show_unique_option;if(this.show_unique_option===true){$(this.el).find(".available_selections, .used_selections").addClass("unique");$(this.el).find(".available_selections, .used_selections").removeClass("caption")}else{$(this.el).find(".available_selections, .used_selections").addClass("caption");$(this.el).find(".available_selections, .used_selections").removeClass("unique")}},use_result_action:function(){this.use_result_option=!this.use_result_option;this.get_members()},save:function(){var l=this;var p=$("<div>Saving...</div>");$(this.el).find(".dialog_body").children().hide();$(this.el).find(".dialog_body").prepend(p);var k=this.show_unique_option;var s=decodeURIComponent(l.member.hierarchy);var t=decodeURIComponent(l.member.level);var q=l.workspace.query.helper.getHierarchy(s);var n=[];var r=this.show_totals_option;if($(this.el).find(".used_selections input").length===0){}else{$(this.el).find(".used_selections .option_value input").each(function(b,a){var d=$(a).val();var c=$(a).attr("label");n.push({uniqueName:decodeURIComponent(d),caption:decodeURIComponent(c)})})}var o=$("#parameter").val();if(q&&q.levels.hasOwnProperty(t)){q.levels[t]["aggregators"]=[];if(r){q.levels[t]["aggregators"].push(r)}q.levels[t].selection={type:"INCLUSION",members:n};if(Settings.ALLOW_PARAMETERS&&o){q.levels[t].selection.parameterName=o;var m=l.workspace.query.helper.model().parameters;if(!m[o]){}}}this.finished()},finished:function(){$("#filter_selections").remove();this.available_members=null;$(this.el).find(".filterbox").autocomplete("destroy").remove();$(this.el).dialog("destroy");$(this.el).remove();this.query.run()}});var DrillthroughModal=Modal.extend({type:"drillthrough",buttons:[{text:"Ok",method:"ok"},{text:"Cancel",method:"close"}],events:{"click .collapsed":"select","click .expand":"select","click .folder_collapsed":"select","click .folder_expanded":"select","click .dialog_footer a":"call","click .parent_dimension input":"select_dimension","click .measure_tree input":"select_measure","click input.all_measures":"select_all_measures","click input.all_dimensions":"select_all_dimensions"},allMeasures:false,templateContent:function(){return $("#template-drillthrough").html()},initialize:function(n){_.extend(this,n);this.options.title=n.title;this.query=n.workspace.query;this.position=n.position;this.action=n.action;Saiku.ui.unblock();_.bindAll(this,"ok","drilled","template");this.render();$(this.el).find(".dialog_body").html(_.template(this.templateContent())(this));$(this.el).find(".maxrows").val(this.maxrows);var h=$("#template-drillthrough-list").html();var j=this.workspace.metadata;var l=null;var k=null;if(j&&j.has("data")){l=j.get("data").dimensions;k=j.get("data").measures}if(!j||!l||!k){if(typeof localStorage!=="undefined"&&localStorage&&localStorage.getItem("cube."+key)!==null){Saiku.session.sessionworkspace.cube[key]=new Cube(JSON.parse(localStorage.getItem("cube."+key)))}else{Saiku.session.sessionworkspace.cube[key]=new Cube({key:key});Saiku.session.sessionworkspace.cube[key].fetch({async:false})}l=Saiku.session.sessionworkspace.cube[key].get("data").dimensions;k=Saiku.session.sessionworkspace.cube[key].get("data").measures}var i=_.template($("#template-drillthrough-dimensions").html())({dimensions:l});var m=_.template($("#template-drillthrough-measures").html())({measures:k,allMeasures:this.allMeasures});$(h).appendTo($(this.el).find(".dialog_body"));$(this.el).find(".sidebar").height(($("body").height()/2)+($("body").height()/6));$(this.el).find(".sidebar").width(380);$(this.el).find(".dimension_tree").html("").append($(i));$(this.el).find(".measure_tree").html("").append($(m));Saiku.i18n.translate()},select:function(c){var d=$(c.target).hasClass("root")?$(c.target):$(c.target).parent().find("span");if(d.hasClass("root")){d.find("a").toggleClass("folder_collapsed").toggleClass("folder_expand");d.toggleClass("collapsed").toggleClass("expand");d.parents("li").find("ul").children("li").toggle()}return false},select_dimension:function(f){var e=$(f.target);var d=e.is(":checked");e.parent().find("input").attr("checked",d)},select_all_dimensions:function(f){var e=$(f.target);var d=e.is(":checked");$(this.el).find(".dimension_tree input").attr("checked",d)},select_all_measures:function(f){var e=$(f.target);var d=e.is(":checked");$(this.el).find(".measure_tree input").attr("checked",d)},select_measure:function(f){var e=$(f.target);var d=e.is(":checked");if(d){}},ok:function(){var i=$("<div>Drilling through...</div>");$(this.el).find(".dialog_body").children().hide();$(this.el).find(".dialog_body").prepend(i);var j="";$(this.el).find(".check_level:checked").each(function(a){if(a>0){j+=", "}j+=$(this).val()});var f=$(this.el).find(".maxrows").val();var h="?maxrows="+f;h=h+(typeof this.position!=="undefined"?"&position="+this.position:"");h+="&returns="+j;if(this.action=="export"){var g=Settings.REST_URL+this.query.url()+"/drillthrough/export/csv"+h;this.close();window.open(g)}else{if(this.action=="table"){Saiku.ui.block("Executing drillthrough...");this.query.action.get("/drillthrough",{data:{position:this.position,maxrows:f,returns:j},success:this.drilled});this.close()}}return false},drilled:function(e,f){var h="";if(f!=null&&f.error!=null){h=safe_tags_replace(f.error)}else{var g=new SaikuTableRenderer();h=g.render(f)}Saiku.ui.unblock();var h='<div id="fancy_results" class="workspace_results" style="overflow:visible">'+h+"</div>";this.remove();$.fancybox(h,{autoDimensions:false,autoScale:false,height:($("body").height()-100),width:($("body").width()-100),transitionIn:"none",transitionOut:"none"})},finished:function(){$(this.el).dialog("destroy").remove();this.query.run()}});var DrillAcrossModal=DrillthroughModal.extend({allMeasures:true,templateContent:function(){return $("#template-drillacross").html()},ok:function(){var d=this;var c={};$(this.el).find(".check_level:checked").each(function(b){var a=$(this).attr("key");if(!c[a]){c[a]=[]}c[a].push($(this).val())});Saiku.ui.block("Executing drillacross...");this.query.action.post("/drillacross",{data:{position:this.position,drill:JSON.stringify(c)},success:function(a,b){d.workspace.query.parse(b);d.workspace.unblock();d.workspace.sync_query();d.workspace.query.run()},error:function(g,h,b){d.workspace.unblock();var a="";if(h&&h.hasOwnProperty("responseText")){a=h.responseText}alert("Error drilling across. Check logs! "+a)}});this.close();return false}});var PermissionsModal=Modal.extend({type:"permissions",buttons:[{text:"Ok",method:"ok"},{text:"Cancel",method:"close"}],events:{"click .add_role":"add_role","click .remove_acl":"remove_acl","submit form":"add_role","click a":"call","click input.private":"keep_private"},rolesacl:{},acltype:"SECURED",initialize:function(g){_.extend(this,g);this.options.title=g.title;this.file=g.file;this.rolesacl={};Saiku.ui.unblock();_.bindAll(this,"ok","add_role","remove_acl");this.bind("open",Saiku.i18n.translate());this.render();$(this.el).find(".dialog_body").html(_.template($("#template-permissions").html())(this));$(this.el).find(".filterbox").autocomplete({minLength:1,source:Saiku.session.roles}).data("autocomplete");var i=new RepositoryAclObject({file:this.file});i.fetch({async:false});var k=(typeof i.get("roles")=="undefined"||i.get("roles")==null?{}:i.get("roles"));this.rolesacl=k;var j=_.template($("#template-permissions-rolelist").html())({roles:k});$(this.el).find(".rolelist").html(j);var h=(typeof i.get("owner")=="undefined"||i.get("owner")==null?"":i.get("owner"));var l=(typeof i.get("type")=="undefined"||i.get("type")==null?null:i.get("type"));if(l!=null&&l=="PRIVATE"){$(this.el).find(".private_owner .owner").text(h);$(this.el).find(".private_owner").show()}$(this.el).find(".i18n").i18n(Saiku.i18n.po_file)},add_role:function(k){var h=this;k.preventDefault();if(this.acltype=="PRIVATE"){return false}var i=$(this.el).find(".filterbox").val();var j=[];var l="";var g=0;if(i&&i.length>0){$(this.el).find(".acl:checked").each(function(a){if(a>0){l+=", "}g++;l+=$(this).val();j.push($(this).val())});if(g>0){h.rolesacl[i]=j;$("<option value='"+i+"'>"+i+" ["+l+"]</option>").appendTo($(this.el).find(".select_roles"));var i=$(this.el).find(".filterbox").val("")}else{alert("You need to chose at least one ACL method for this role.")}}return false},keep_private:function(c){var d=$(this.el).find("input.private").is(":checked");if(d){$(this.el).find(".permissions").addClass("disabled_toolbar");$("input.acl, input.filterbox, input.add_role, input.remove_acl").prop("disabled",true);this.acltype="PRIVATE"}else{$(this.el).find(".permissions").removeClass("disabled_toolbar");$("input.acl, input.filterbox, input.add_role, input.remove_acl").prop("disabled",false);this.acltype="SECURED"}},remove_acl:function(c){var d=this;if(this.acltype=="PRIVATE"){return false}$(this.el).find(".select_roles option:selected").each(function(a){delete d.rolesacl[$(this).val()]});$(this.el).find(".select_roles option:selected").remove();return false},ok:function(){var c=this.close();var d={};if(this.acltype=="PRIVATE"){d={type:"PRIVATE",owner:Saiku.session.username}}else{d={type:"SECURED",roles:this.rolesacl,owner:Saiku.session.username}}(new RepositoryAclObject({file:this.file,acl:JSON.stringify(d)})).save({success:c});return false}});var DemoLoginForm=Modal.extend({type:"login",message:"<form id='demo_form'><label for='email'>Email:</label><input type='text' id='email' name='email' value='' /></form>",buttons:[{text:"Start Demo",method:"login"}],events:{"click a":"call","submit form ":"login"},initialize:function(b){_.extend(this,b);_.bindAll(this,"adjust");this.options.title=Settings.VERSION;this.bind("open",this.adjust)},adjust:function(){$(this.el).parent().find(".ui-dialog-titlebar-close").hide();$(this.el).find("#email").select().focus()},login:function(i){var g=Settings.USERNAME;var j=Settings.PASSWORD;var e=$(this.el).find("#email").val();if(e){var h=new logger({url:Settings.TELEMETRY_SERVER+"/input/demo"});h.log({email:e,created_at:Math.round((new Date()).getTime()/1000)});$(this.el).dialog("close");this.session.login(g,j)}if(i){i.preventDefault();i.stopPropagation()}return true}});var LoginForm=Modal.extend({type:"login",message:"<form id='login_form'><label for='username'>Username</label><input type='text' id='username' name='username' value='' /><label for='password'>Password</label><input type='password' id='password' name='password' value='' /></form>",buttons:[{text:"Login",method:"login"}],events:{"click a":"call","keyup #login_form input":"check"},initialize:function(b){_.extend(this,b);_.bindAll(this,"adjust");this.options.title=Settings.VERSION;this.bind("open",this.adjust)},adjust:function(){$(this.el).parent().find(".ui-dialog-titlebar-close").hide();$(this.el).find("#username").select().focus()},check:function(b){if(b.which===13){this.login()}},login:function(){var d=$(this.el).find("#username").val();var c=$(this.el).find("#password").val();$(this.el).dialog("close");this.session.login(d,c);return true}});var AboutModal=Modal.extend({initialize:function(){_.extend(this.options,{title:"About "+Settings.VERSION})},events:{"click a":"dummy"},dummy:function(){return true},type:"info",message:Settings.VERSION+"<br><a  target='_blank' href='http://www.analytical-labs.com'>http://www.analytical-labs.com/</a><br><br>Powered by <img width='20px' src='/images/src/meteorite_free.png'  /> <a target='_blank' href='http://meteorite.bi'>http://meteorite.bi/</a> "});var AddFolderModal=Modal.extend({type:"save",closeText:"Save",events:{"click .form_button":"save","submit form":"save"},buttons:[{text:"OK",method:"save"}],initialize:function(c){var d=this;this.success=c.success;this.path=c.path;this.message="<form id='add_folder'><label class='i18n' for='name'>To add a new folder, please type a name in the text box below:</label><input type='text' class='newfolder' name='name' /></form>";_.extend(this.options,{title:"Add Folder"});if(isIE&&isIE<9){$(this.el).find("form").on("submit",this.save)}},type:"save",save:function(g){g.preventDefault();var f=this;var e=$(this.el).find('input[name="name"]').val();var h=this.path+e;(new SavedQuery({file:h,name:e})).save({},{success:f.success,dataType:"text",error:this.error});this.close();return false},error:function(){$(this.el).find("dialog_body").html("Could not add new folder")}});var FilterModal=Modal.extend({type:"filter",closeText:"Save",events:{"submit form":"save","click .dialog_footer a":"call"},buttons:[{text:"OK",method:"save"},{text:"Cancel",method:"close"}],message:"",expression_text:function(){var b="<form id='custom_filter'><table border='0px'>";if(this.expressionType=="Order"){b+="<tr><td class='col1'>Sort Type: <select id='fun'><option>ASC</option><option>BASC</option><option>DESC</option><option>BDESC</option> </select></td></tr>"}b+="<tr><td class='col1'>"+this.expressionType+" MDX Expression:</td></tr><tr><td class='col1'><textarea class='filter_expression'></textarea></td></tr></table></form>";return b},expression:" ",expressonType:"",initialize:function(c){var d=this;this.axis=c.axis;this.query=c.query;this.success=c.success;this.expression=c.expression;this.expressionType=c.expressionType;_.bindAll(this,"save","expression_text");_.extend(this.options,{title:"Custom "+this.expressionType+" for "+this.axis});this.message=this.expression_text(this.expressionType);this.bind("open",function(){$(this.el).find("textarea").val("").val(d.expression)});if(isIE&&isIE<9){$(this.el).find("form").on("submit",this.save)}},save:function(g){g.preventDefault();var f=this;this.expression=$(this.el).find("textarea").val();var e="";if(typeof this.expression=="undefined"||!this.expression||this.expression==""){e+="You have to enter a MDX expression for the "+this.expressionType+" function! ";alert(e)}else{if(f.expressionType=="Order"){var h=$("#fun").val();f.success(h,this.expression)}else{f.success(this.expression)}this.close()}return false},error:function(){$(this.el).find("dialog_body").html("Could not add new folder")}});var CustomFilterModal=Modal.extend({type:"filter",closeText:"Save",events:{"submit form":"save","change .function":"switch_function","change .type":"switch_type","click .dialog_footer a":"call"},buttons:[{text:"OK",method:"save"},{text:"Cancel",method:"close"}],message:"<form id='custom_filter'><table border='0px'><tr><td class='col0'>Define Filter:</td><td class='col1'><select class='function'><option>Select a Function...</option><option value='TopCount'>TopCount</option><option value='TopPercent'>TopPercent</option><option value='TopSum'>TopSum</option><option value='BottomCount'>BottomCount</option><option value='BottomPercent'>BottomPercent</option><option value='BottomSum'>BottomSum</option></select></td></tr><tr class='filter_details hide'><td><span class='ntype'></span></td><td><input class='n' /></td></tr><tr class='filter_details hide'><td>Sort by:</td><td><select class='type'><option value='measure'>Measure</option><option value='custom'>MDX Expression</option></select></td></tr><tr class='filter_details hide'><td>&nbsp;</td><td class='sortingoption'>&nbsp;</td></table></form>",func:null,func_type:"Measure",n:"",sortliteral:"",measure_list:null,initialize:function(c){var d=this;this.axis=c.axis;this.measures=c.measures;this.query=c.query;this.success=c.success;this.func=c.func;this.n=c.n;this.sortliteral=c.sortliteral;this.isMdx=true;_.bindAll(this,"build_measures_list","save");this.measure_list=this.build_measures_list();_.extend(this.options,{title:"Custom Filter for "+this.axis});this.bind("open",function(){if(d.func!=null){$(d.el).find(".function").val(d.func);d.switch_function({target:$(d.el).find(".function")});$(d.el).find(".n").val(d.n);if(d.isMdx==true&&d.sortliteral!=null){$(this.el).find(".type").val("custom");$(this.el).find(".sortingoption").html("").html("<textarea class='sortliteral'>"+d.sortliteral+"</textarea>")}}});if(isIE&&isIE<9){$(this.el).find("form").on("submit",this.save)}},build_measures_list:function(){var c=this;if(this.measure_list!=null){return""}var d="<select class='sortliteral'>";_.each(this.measures,function(a){var b="";if(a.uniqueName==c.sortliteral){b=" selected ";c.isMdx=false}d+="<option "+b+"value='"+a.uniqueName+"'>"+a.caption+"</option>"});d+="</select>";return d},switch_function:function(d){var f=$(d.target).val();if(typeof f=="undefined"||f==""){$(this.el).find(".filter_details").hide()}else{var e=f.replace("Top","").replace("Bottom","");$(this.el).find(".ntype").html(e+":");$(this.el).find(".filter_details").show();$(this.el).find(".sortingoption").html("").html(this.measure_list)}return false},switch_type:function(c){var d=$(c.target).val();if(d=="measure"){$(this.el).find(".sortingoption").html("").html(this.measure_list)}else{$(this.el).find(".sortingoption").html("").html("<textarea class='sortliteral' />")}return false},save:function(f){f.preventDefault();var e=this;this.func=$(this.el).find(".function").val();this.n=parseInt($(this.el).find(".n").val());this.sortliteral=$(this.el).find(".sortliteral").val();var d="";if(typeof this.n=="undefined"||!this.n){d+="You have to enter a numeric for N! "}if(typeof this.sortliteral=="undefined"||!this.sortliteral||this.sortliteral==""){d+="You have to enter a MDX expression for the sort literal! "}if(d!=""){alert(d)}else{e.success(this.func,this.n,this.sortliteral);this.close()}return false},error:function(){$(this.el).find("dialog_body").html("Could not add new folder")}});var MeasuresModal=Modal.extend({type:"filter",closeText:"Save",events:{"submit form":"save","click .dialog_footer a":"call"},buttons:[{text:"OK",method:"save"},{text:"Cancel",method:"close"}],message:"<form id='measure_form'><table border='0px'><tr><td class='col0 i18n'>Name:</td><td class='col1'><input type='text' class='measure_name' value='Measure Name'></input></td></tr><tr><td class='col0 i18n'>Formula:</td><td class='col1'><textarea class='measureFormula'>Measures.[Store Sales] + 100</textarea></td></tr><tr><td class='col0 i18n'>Format:</td><td class='col1'><input class='measure_format' type='text' value='#,##0.00'></input></td></tr></table></form>",measure:null,initialize:function(c){var d=this;this.workspace=c.workspace;this.measure=c.measure;_.bindAll(this,"save");this.options.title="Calculated Measure";if(this.measure){_.extend(this.options,{title:"Custom Filter for "+this.axis})}this.bind("open",function(){if(d.measure){}});if(isIE&&isIE<9){$(this.el).find("form").on("submit",this.save)}},save:function(l){l.preventDefault();var h=this;var j=$(this.el).find(".measure_name").val();var k=$(this.el).find(".measureFormula").val();var m=$(this.el).find(".measure_format").val();var n="";if(typeof j=="undefined"||!j){n+="You have to enter a name for the measure! "}if(typeof k=="undefined"||!k||k===""){n+="You have to enter a MDX formula for the calculated measure! "}if(n!=""){alert(n)}else{var i={name:j,formula:k,properties:{},uniqueName:"[Measures]."+j};if(m){i.properties.FORMAT_STRING=m}h.workspace.query.helper.addCalculatedMeasure(i);h.workspace.sync_query();this.close()}return false},error:function(){$(this.el).find("dialog_body").html("Could not add new folder")}});var QueryToolbar=Backbone.View.extend({events:{"click .options a.button":"call","click .renderer a.button":"switch_render_button"},chart:{},render_mode:"table",spark_mode:null,initialize:function(b){this.workspace=b.workspace;_.bindAll(this,"call","activate_buttons","spark_bar","spark_line","render_row_viz","run_row_viz","switch_render_button");this.render_mode="table";this.spark_mode=null;this.workspace.bind("query:new",this.activate_buttons);this.workspace.bind("query:result",this.activate_buttons);this.workspace.bind("table:rendered",this.run_row_viz)},activate_buttons:function(b){if(typeof b!="undefined"&&b!=null){$(this.el).find("a").removeClass("disabled_toolbar");if(!b.data){$(this.el).find("a.export_button, a.stats").addClass("disabled_toolbar")}if(isIE||Settings.BIPLUGIN5){$(this.el).find("a.export_button").addClass("disabled_toolbar")}}},template:function(){var b=$("#template-query-toolbar").html()||"";return _.template(b)()},render:function(){$(this.el).html(this.template());$(this.el).find("render_table").addClass("on");$(this.el).find("ul.table").show();return this},switch_render_button:function(c){var e=$(c.target);c.preventDefault();if($(c.target).hasClass("disabled_toolbar")){return false}e.parent().siblings().find(".on").removeClass("on");if(e.hasClass("render_chart")){this.switch_render("chart");this.workspace.query.setProperty("saiku.ui.render.mode","chart");var f=$(this.el).find("ul.chart li a.on:first").size()>0?$(this.el).find("ul.chart li a.on:first").attr("href").replace("#",""):null;if(f!=null){this.workspace.query.setProperty("saiku.ui.render.type",f)}}else{this.switch_render("table");this.workspace.query.setProperty("saiku.ui.render.mode","table");this.workspace.query.setProperty("saiku.ui.render.type",this.spark_mode)}},switch_render:function(c){c=(typeof c!="undefined"?c.toLowerCase():"table");$(this.el).find("ul.renderer a.on").removeClass("on");$(this.el).find("ul.renderer a.render_"+c).addClass("on");if("chart"==c){$(this.el).find("ul.chart").show();$(this.el).find("ul.table").hide();this.render_mode="chart";$(this.workspace.el).find(".workspace_results").children().hide();$(this.workspace.chart.el).find(".canvas_wrapper").hide();this.workspace.chart.show()}else{$(this.el).find("ul.chart").hide();$(this.el).find("ul.table").show();$(this.el).find("ul.table .stats").removeClass("on");$(this.workspace.el).find(".workspace_results").children().hide();$(this.workspace.el).find(".workspace_results .table_wrapper").show();$(this.workspace.chart.el).hide().children().hide();this.render_mode="table";var d=this.workspace.query.result.hasRun();if(d){this.workspace.table.render({data:this.workspace.query.result.lastresult()})}}return false},call:function(d){var e=$(d.target).hasClass("button")?$(d.target):$(d.target).parent();if(!e.hasClass("disabled_toolbar")){var f=e.attr("href").replace("#","");if(this.render_mode=="table"&&this[f]){this[f](d)}else{if(this.render_mode=="chart"){if(e.hasClass("chartoption")){e.parent().siblings().find(".chartoption.on").removeClass("on");e.addClass("on")}if(f=="export_button"){this.workspace.chart[f](d)}else{this.workspace.chart.renderer.switch_chart(f);this.workspace.query.setProperty("saiku.ui.render.type",f)}}}}d.preventDefault();return false},spark_bar:function(){$(this.el).find("ul.table .spark_bar").toggleClass("on");$(this.el).find("ul.table .spark_line").removeClass("on");$(this.workspace.table.el).find("td.spark").remove();if($(this.el).find("ul.table .spark_bar").hasClass("on")){this.spark_mode="spark_bar";this.workspace.query.setProperty("saiku.ui.render.type","spark_bar");_.delay(this.render_row_viz,10,"spark_bar")}else{this.spark_mode=null}},spark_line:function(){$(this.el).find("ul.table .spark_line").toggleClass("on");$(this.el).find("ul.table .spark_bar").removeClass("on");$(this.workspace.table.el).find("td.spark").remove();if($(this.el).find("ul.table .spark_line").hasClass("on")){this.spark_mode="spark_line";this.workspace.query.setProperty("saiku.ui.render.type","spark_line");_.delay(this.render_row_viz,10,"spark_line")}else{this.spark_mode=null}},run_row_viz:function(b){if(this.render_mode=="table"&&this.spark_mode!=null){this.render_row_viz(this.spark_mode)}},render_row_viz:function(b){$(this.workspace.table.el).find("tr").each(function(a,j){var g=[];$(j).find("td.data div").each(function(e,d){var c=$(d).attr("alt");c=(typeof c!="undefined"&&c!=""&&c!=null&&c!="undefined")?parseFloat(c):0;g.push(c)});$("<td class='data spark'>&nbsp;<div id='chart"+a+"'></div></td>").appendTo($(j));var i=g.length*9;if(g.length>0){var h=new pv.Panel().canvas("chart"+a).height(12).width(i).margin(0);if(b=="spark_bar"){h.add(pv.Bar).data(g).left(pv.Scale.linear(0,g.length).range(0,i).by(pv.index)).height(pv.Scale.linear(0,_.max(g)).range(0,12)).width(6).bottom(0)}else{if(b=="spark_line"){i=i/2;h.width(i);h.add(pv.Line).data(g).left(pv.Scale.linear(0,g.length-1).range(0,i).by(pv.index)).bottom(pv.Scale.linear(g).range(0,12)).strokeStyle("#000").lineWidth(1)}}h.render()}})}});var WorkspaceToolbar=Backbone.View.extend({enabled:false,events:{"click a":"call"},initialize:function(b){this.workspace=b.workspace;_.bindAll(this,"call","reflect_properties","run_query","swap_axes_on_dropzones","display_drillthrough","clicked_cell_drillthrough_export","clicked_cell_drillacross","clicked_cell_drillthrough","activate_buttons","switch_to_mdx","post_mdx_transform","toggle_fields_action");this.workspace.bind("properties:loaded",this.reflect_properties);this.workspace.trigger("workspace:toolbar:render",{workspace:this.workspace});this.workspace.bind("query:new",this.activate_buttons);this.workspace.bind("query:result",this.activate_buttons)},activate_buttons:function(b){if(b!=null&&b.data&&b.data.cellset&&b.data.cellset.length>0){$(b.workspace.toolbar.el).find(".button").removeClass("disabled_toolbar");$(b.workspace.el).find("td.data").removeClass("cellhighlight").unbind("click");$(b.workspace.el).find(".table_mode").removeClass("on")}else{$(b.workspace.toolbar.el).find(".button").addClass("disabled_toolbar").removeClass("on");$(b.workspace.el).find(".fields_list .disabled_toolbar").removeClass("disabled_toolbar");$(b.workspace.toolbar.el).find(".new, .open, .save, .edit, .run,.auto,.non_empty,.toggle_fields,.toggle_sidebar,.switch_to_mdx, .mdx").removeClass("disabled_toolbar")}this.reflect_properties()},template:function(){var b=$("#template-workspace-toolbar").html()||"";return _.template(b)()},render:function(){$(this.el).html(this.template());return this},call:function(d){d.preventDefault();var c=d.target.hash.replace("#","");if(!$(d.target).hasClass("disabled_toolbar")&&this[c]){this[c](d)}return false},reflect_properties:function(){var b=this.workspace.query.model.properties?this.workspace.query.model.properties:Settings.QUERY_PROPERTIES;if(b["saiku.olap.query.nonempty"]===true){$(this.el).find(".non_empty").addClass("on")}if(b["saiku.olap.query.automatic_execution"]===true){$(this.el).find(".auto").addClass("on")}if(b["saiku.olap.query.drillthrough"]!==true){$(this.el).find(".drillthrough, .drillthrough_export").addClass("disabled_toolbar")}if(b["org.saiku.query.explain"]!==true){$(this.el).find(".explain_query").addClass("disabled_toolbar")}if(b["org.saiku.connection.scenario"]!==true){$(this.el).find(".query_scenario").addClass("disabled_toolbar")}else{$(this.el).find(".query_scenario").removeClass("disabled_toolbar");$(this.el).find(".drillthrough, .drillthrough_export").addClass("disabled_toolbar")}if(b["saiku.olap.query.limit"]=="true"||b["saiku.olap.query.filter"]==true){$(this.workspace.el).find(".fields_list_header").addClass("limit")}if(this.workspace.query.getProperty("saiku.olap.result.formatter")!=="undefined"&&this.workspace.query.getProperty("saiku.olap.result.formatter")=="flattened"){if(!$(this.el).find(".group_parents").hasClass("on")){$(this.el).find(".group_parents").addClass("on")}}if($(this.workspace.el).find(".workspace_results tbody.ui-selectable").length>0){$(this.el).find(".zoom_mode").addClass("on")}$(this.el).find(".spark_bar, .spark_line").removeClass("on");$(this.el).find("a.edit").removeClass("disabled_toolbar");if(Settings.MODE=="VIEW"||this.workspace.isReadOnly){$(this.el).find("a.edit").hide();$(this.el).find("a.save").hide()}else{if(this.workspace.viewState=="view"){$(this.el).find("a.edit").removeClass("on")}else{$(this.el).find("a.edit").addClass("on")}$(this.el).find("a.edit").show("normal")}},new_query:function(b){this.workspace.switch_view_state("edit");this.workspace.new_query();return false},edit_query:function(b){$(b.target).toggleClass("on");if($(b.target).hasClass("on")){this.workspace.switch_view_state("edit")}else{this.workspace.switch_view_state("view")}},save_query:function(f){var e=this;if(this.workspace.query){if(typeof this.editor!="undefined"){var d=this.editor.getValue();this.workspace.query.model.mdx=d}(new SaveQuery({query:this.workspace.query})).render().open()}},open_query:function(b){(new OpenDialog()).render().open()},run_query:function(b){this.workspace.query.run(true)},automatic_execution:function(d){var c=!this.workspace.query.getProperty("saiku.olap.query.automatic_execution");this.workspace.query.setProperty("saiku.olap.query.automatic_execution",c);if(c){$(d.target).addClass("on")}else{$(d.target).removeClass("on")}},toggle_fields:function(c){var d=this;if(c){$(this.el).find(".toggle_fields").toggleClass("on")}if(!$(this.el).find(".toggle_fields").hasClass("on")){this.toggle_fields_action("hide")}else{this.toggle_fields_action("show")}},toggle_fields_action:function(d,f){var e=this;if(d=="show"&&$(".workspace_editor").is(":visible")){return}else{if(d=="hide"&&$(".workspace_editor").is(":hidden")){return}}if(f){$(".workspace_editor").css("height","");if($(".workspace_editor").is(":hidden")){$(".workspace_editor").show()}else{$(".workspace_editor").hide()}return}if(d=="hide"){$(this.workspace.el).find(".workspace_editor").hide()}else{$(this.workspace.el).find(".workspace_editor").show()}},toggle_sidebar:function(){this.workspace.toggle_sidebar()},group_parents:function(b){$(b.target).toggleClass("on");if($(b.target).hasClass("on")){this.workspace.query.setProperty("saiku.olap.result.formatter","flattened")}else{this.workspace.query.setProperty("saiku.olap.result.formatter","flat")}this.workspace.query.run()},non_empty:function(c){var d=!this.workspace.query.getProperty("saiku.olap.query.nonempty");this.workspace.query.helper.nonEmpty(d);this.workspace.query.setProperty("saiku.olap.query.nonempty",d);$(c.target).toggleClass("on");this.workspace.query.run()},swap_axis:function(b){$(this.workspace.el).find(".workspace_results table").html("");this.workspace.query.helper.swapAxes();this.workspace.sync_query();this.workspace.query.run(true)},check_modes:function(c){if(typeof c==="undefined"||c==null){return}if($(this.workspace.el).find(".workspace_results tbody.ui-selectable").length>0){$(this.workspace.el).find(".workspace_results tbody").selectable("destroy")}if(!$(c).hasClass("on")){$(this.workspace.el).find("td.data").removeClass("cellhighlight").unbind("click");$(this.workspace.el).find(".table_mode").removeClass("on");this.workspace.query.run()}else{if($(c).hasClass("drillthrough_export")){$(this.workspace.el).find("td.data").addClass("cellhighlight").unbind("click").click(this.clicked_cell_drillthrough_export);$(this.workspace.el).find(".query_scenario, .drillthrough, .zoom_mode, .drillacross").removeClass("on")}else{if($(c).hasClass("drillthrough")){$(this.workspace.el).find("td.data").addClass("cellhighlight").unbind("click").click(this.clicked_cell_drillthrough);$(this.workspace.el).find(".query_scenario, .drillthrough_export, .zoom_mode, .drillacross").removeClass("on")}else{if($(c).hasClass("query_scenario")){this.workspace.query.scenario.activate();$(this.workspace.el).find(".drillthrough, .drillthrough_export, .zoom_mode, .drillacross").removeClass("on")}else{if($(c).hasClass("drillacross")){$(this.workspace.el).find("td.data").addClass("cellhighlight").unbind("click").click(this.clicked_cell_drillacross);$(this.workspace.el).find(".query_scenario, .drillthrough, .drillthrough_export, .zoom_mode").removeClass("on")}else{if($(c).hasClass("zoom_mode")){var d=this;$(d.workspace.el).find(".workspace_results tbody").selectable({filter:"td",stop:function(b,a){var f=[];$(d.workspace.el).find(".workspace_results").find("td.ui-selected div").each(function(j,i){var e=$(i).attr("rel");if(e){f.push(e)}});$(d.workspace.el).find(".workspace_results").find(".ui-selected").removeClass(".ui-selected");f=_.uniq(f);if(f.length>0){d.workspace.query.action.put("/zoomin",{success:function(e,h){d.workspace.query.parse(h);d.workspace.unblock();d.workspace.sync_query();Saiku.ui.unblock();d.workspace.query.run()},data:{selections:JSON.stringify(f)}})}}});$(this.workspace.el).find(".drillthrough, .drillthrough_export, .query_scenario, .drillacross").removeClass("on")}}}}}}},query_scenario:function(b){$(b.target).toggleClass("on");this.check_modes($(b.target))},zoom_mode:function(b){$(b.target).toggleClass("on");this.check_modes($(b.target))},drillacross:function(b){$(b.target).toggleClass("on");this.check_modes($(b.target))},drillthrough:function(b){$(b.target).toggleClass("on");this.check_modes($(b.target))},display_drillthrough:function(c,d){this.workspace.table.render({data:d});Saiku.ui.unblock()},export_drillthrough:function(b){$(b.target).toggleClass("on");this.check_modes($(b.target))},clicked_cell_drillacross:function(d){$target=$(d.target).hasClass("data")?$(d.target).find("div"):$(d.target);var c=$target.attr("rel");(new DrillAcrossModal({workspace:this.workspace,title:"Drill Across",action:"export",position:c,query:this.workspace.query})).open()},clicked_cell_drillthrough_export:function(d){$target=$(d.target).hasClass("data")?$(d.target).find("div"):$(d.target);var c=$target.attr("rel");(new DrillthroughModal({workspace:this.workspace,maxrows:10000,title:"Drill-Through to CSV",action:"export",position:c,query:this.workspace.query})).open()},clicked_cell_drillthrough:function(d){$target=$(d.target).hasClass("data")?$(d.target).find("div"):$(d.target);var c=$target.attr("rel");(new DrillthroughModal({workspace:this.workspace,maxrows:200,title:"Drill-Through",action:"table",success:this.display_drillthrough,position:c,query:this.workspace.query})).open()},swap_axes_on_dropzones:function(c,d){this.workspace.query.parse(d);this.workspace.unblock();this.workspace.sync_query();Saiku.ui.unblock()},show_mdx:function(b){this.workspace.query.enrich();(new MDXModal({mdx:this.workspace.query.model.mdx})).render().open()},export_xls:function(b){window.location=Settings.REST_URL+this.workspace.query.url()+"/export/xls/"+this.workspace.query.getProperty("saiku.olap.result.formatter")},export_csv:function(b){window.location=Settings.REST_URL+this.workspace.query.url()+"/export/csv"},export_pdf:function(b){window.location=Settings.REST_URL+this.workspace.query.url()+"/export/pdf/"+this.workspace.query.getProperty("saiku.olap.result.formatter")},switch_to_mdx:function(i){var g=this;$(this.workspace.el).find(".workspace_fields").addClass("hide");$(this.el).find(".auto, .query_scenario, .buckets, .non_empty, .swap_axis, .mdx, .switch_to_mdx, .zoom_mode, .drillacross").parent().hide();if($(this.workspace.el).find(".workspace_results tbody.ui-selectable").length>0){$(this.workspace.el).find(".workspace_results tbody").selectable("destroy")}$(this.el).find(".run").attr("href","#run_mdx");$(this.el).find(".run, .save, .open, .new, .edit").removeClass("disabled_toolbar");if(Settings.MODE!="view"&&Settings.MODE!="table"&&!this.workspace.isReadOnly){$mdx_editor=$(this.workspace.el).find(".mdx_input");$(this.workspace.el).find(".workspace_editor .mdx_input, .workspace_editor .editor_info, .workspace_editor").removeClass("hide").show();this.editor=ace.edit("mdx_editor");this.editor.setShowPrintMargin(false);this.editor.setFontSize(11);this.editor.commands.addCommand({name:"runmdx",bindKey:{win:"Ctrl-Enter",mac:"Command-Enter"},exec:function(a){g.run_mdx()},readOnly:true});var f=function(){var a=g.editor.getCursorPosition();$mdx_editor.parent().find(".editor_info").html("&nbsp; "+(a.row+1)+", "+a.column)};this.editor.on("changeSelection",f);f();var h=function(){var a=$(document).height()/3;var d=Math.floor(a/g.editor.renderer.lineHeight);var b=g.editor.getSession().getScreenLength()>d?d:g.editor.getSession().getScreenLength();var c=(b+1)*g.editor.renderer.lineHeight+g.editor.renderer.scrollBar.getWidth();$mdx_editor.height(c.toString()+"px");g.editor.resize();g.workspace.adjust()};var j=function(){var a=g.editor.session;g.editor.resize();a.setUseWrapMode(true);if(a.getUseWrapMode()){var b=g.editor.renderer.characterWidth;var c=g.editor.renderer.scroller.clientWidth;if(c>0){a.setWrapLimitRange(null,parseInt(c/b,10))}}};j();h();g.editor.focus();g.editor.clearSelection();g.editor.getSession().setValue("");g.editor.getSession().on("change",h);$(window).resize(j);g.editor.on("changeSelection",h);g.editor.on("focus",function(a){h();return true});g.editor.on("blur",function(a){if($(g.workspace.el).find(".mdx_input").height()>100){$(g.workspace.el).find(".mdx_input").height(100)}g.editor.resize();g.workspace.adjust();return true});this.editor.getSession().setMode("ace/mode/text")}if(this.workspace.dimension_list){$(this.workspace.el).find(".sidebar_inner ul li a").css({fontWeight:"normal"}).parent("li").removeClass("ui-draggable ui-draggable-disabled ui-state-disabled")}this.activate_buttons({workspace:this.workspace});$(this.workspace.toolbar.el).find(".run").removeClass("disabled_toolbar");$(this.workspace.table.el).empty();this.workspace.adjust();this.post_mdx_transform()},post_mdx_transform:function(){var e=this;if(this.workspace.query.model.type!=="MDX"){this.workspace.query.enrich();this.workspace.query.model.queryModel={};this.workspace.query.model.type="MDX";this.workspace.query.setProperty("saiku.olap.result.formatter","flat");e.workspace.query.helper.model().parameters={}}var h=this.workspace.query.model.mdx;if(e.editor){e.editor.setValue(h,0);e.editor.clearSelection();e.editor.focus()}$(e.el).find(".group_parents").removeClass("on");if(Settings.ALLOW_PARAMETERS){var g=function(){var d=e.editor.getValue();var i=[];if(d){for(var n=0,p=d.length;n<(p-1);n++){if(d[n]==="$"&&d[n+1]==="{"){var b="";var o=false;for(n=n+2;n<p;n++){if(d[n]!=="}"){b+=d[n]}else{o=true;n++;break}}if(o&&b&&b.length>0){i.push(b)}}}}var c=e.workspace.query.helper.model().parameters;var a={};_.each(i,function(j){if(!c[j]){a[j]=""}else{a[j]=c[j]}});e.workspace.query.helper.model().parameters=a;e.workspace.update_parameters()};var f=function(){_.delay(g,1000)};e.editor.getSession().off("change",f);e.editor.getSession().on("change",f);e.workspace.update_parameters()}},run_mdx:function(c){if($(this.workspace.el).find(".mdx_input").height()>100){$(this.workspace.el).find(".mdx_input").height(100)}this.editor.resize();var d=this.editor.getValue();this.workspace.query.model.mdx=d;this.workspace.query.run(true)},explain_query:function(f){var e=this;var d=function(c,h){var a="<textarea style='width: "+($("body").width()-165)+"px;height:"+($("body").height()-175)+"px;'>";if(h!=null&&h.error!=null){a+=h.error}else{if(h.cellset&&h.cellset.length===0){a+="Empty explain plan!"}else{a+=h.cellset[1][0].value}}a+="</textarea>";Saiku.ui.unblock();var b=a;var b='<div id="fancy_results" class="workspace_results" style="overflow:visible"><table><tr><th clas=\'row_header\'>Explain Plan</th></tr><tr><td>'+a+"</td></tr></table></div>";$.fancybox(b,{autoDimensions:false,autoScale:false,height:($("body").height()-100),width:($("body").width()-100),transitionIn:"none",transitionOut:"none"})};e.workspace.query.action.get("/explain",{success:d});return false}});var WorkspaceDropZone=Backbone.View.extend({template:function(){var b=$("#template-workspace-dropzones").html()||"";return _.template(b)()},events:{"sortstop .fields_list_body.details":"set_measures","sortstop .axis_fields":"select_dimension","click .d_measure":"remove_measure_click","click .d_level":"selections","click .axis_fields_header.limit":"limit_axis","click .clear_axis":"clear_axis"},initialize:function(b){this.workspace=b.workspace;_.bindAll(this,"clear_axis")},render:function(){var b=this;$(this.el).html(this.template());$(this.el).find(".fields_list_body.details ul.connectable").sortable({items:"> li",opacity:0.6,placeholder:"placeholder",tolerance:"pointer",containment:$(b.workspace.el),start:function(a,d){d.placeholder.text(d.helper.text())}});$(this.el).find(".axis_fields ul.connectable").sortable({connectWith:$(b.el).find(".axis_fields ul.connectable"),forcePlaceholderSize:false,forceHelperSize:true,items:"li.selection",opacity:0.6,placeholder:"placeholder",tolerance:"touch",cursorAt:{top:10,left:60},containment:$(b.workspace.el),start:function(f,e){var a=$(e.helper).find("a").parent().parent().attr("hierarchycaption");e.placeholder.text(a);$(e.helper).css({width:"auto",height:"auto"});$(b.el).find(".axis_fields ul.hierarchy li.d_level:visible").addClass("temphide").hide()}});return this},set_measures:function(d,f){var e=[];$(this.el).find(".fields_list_body.details ul.connectable li.d_measure").each(function(c,b){var a={name:$(b).find("a").attr("measure"),type:$(b).find("a").attr("type")};e.push(a)});this.workspace.query.helper.setMeasures(e);this.workspace.sync_query();this.workspace.query.run()},remove_measure_click:function(d){d.preventDefault();var c=$(d.target).hasClass("d_measure")?$(d.target).find("a"):$(d.target);c.parent().remove();this.set_measures()},remove_dimension:function(j,i){if($(i.helper).hasClass("d_measure")){$(i.helper).detach();this.set_measures()}else{var g=$(i.helper).find("a").attr("hierarchy");var f=$(this.el).find('ul.hierarchy[hierarchy="'+g+'"]').parents(".fields_list").attr("title");var h=$(i.helper).find("a").attr("level");this.workspace.query.helper.removeHierarchy(g);this.workspace.sync_query();this.workspace.query.run()}},synchronize_query:function(){var g=this;this.reset_dropzones();var l=this.workspace.query.helper.model();if(l.hasOwnProperty("queryModel")&&l.queryModel.hasOwnProperty("axes")){var i=l.queryModel.axes;for(var k in i){var h=$(g.el).find('.fields_list[title="'+k+'"]');_.each(i[k].hierarchies,function(d){var b=$(g.workspace.dimension_list.el).find('ul.d_hierarchy[hierarchy="'+d.name+'"]').clone().removeClass("d_hierarchy").addClass("hierarchy");b.find("li.d_level").hide();for(var a in d.levels){b.find('li a[level="'+a+'"]').parent().show();$(g.workspace.dimension_list.el).find('ul.d_hierarchy[hierarchy="'+d.name+'"] li a[level="'+a+'"]').parent().draggable("disable").parents(".parent_dimension").find(".folder_collapsed").addClass("selected")}var c=$('<li class="selection"></li>');c.append(b);c.appendTo(h.find("ul.connectable"))})}var j=l.queryModel.details.measures||[];_.each(j,function(a){var c=$(g.workspace.dimension_list.el).find('.measure_tree a.measure[measure="'+a.name+'"]').parent();var b=c.clone().show();b.appendTo($(g.el).find(".fields_list_body.details ul.connectable"));c.draggable("disable")});this.update_dropzones()}},reset_dropzones:function(){var b=this;$(b.el).find(".fields_list_body ul.connectable").find("li.selection, li.d_measure").remove();$(b.workspace.dimension_list.el).find("li.ui-draggable-disabled").draggable("enable");$(b.el).find('.fields_list[title="ROWS"] .limit').removeClass("on");$(b.el).find('.fields_list[title="COLUMNS"] .limit').removeClass("on");$(this.workspace.el).find(".fields_list_body .clear_axis").addClass("hide")},update_dropzones:function(){$(this.workspace.el).find(".fields_list_body").each(function(e,f){var d=$(f);if(d.find("ul.connectable li.selection, ul.connectable li.d_measure").length==0){d.siblings(".clear_axis").addClass("hide")}else{d.siblings(".clear_axis").removeClass("hide")}})},clear_axis:function(f){var e=this;f.preventDefault();var d=$(f.target).siblings(".fields_list_body").parent().attr("title");if(d=="DETAILS"){this.workspace.query.helper.clearMeasures()}else{this.workspace.query.helper.clearAxis(d)}this.workspace.sync_query();this.workspace.query.run();return false},select_dimension:function(q,m){var j=this;if(false||$(m.item).is(":visible")){$(j.el).find(".axis_fields ul.hierarchy").each(function(b,a){$(a).find("li.temphide").show().removeClass("temphide")});var n=m.item.find(".level").attr("hierarchy");var k=-1;m.item.parents("ul.connectable").find("li.selection").each(function(b,a){if($(a).find("ul.hierarchy").attr("hierarchy")==n){k=b}});var p=m.item.parents(".axis_fields").parent().attr("title");var l=$(q.target).parents(".axis_fields").parent().attr("title");var o=m.item.hasClass("d_level");if(o){var r=m.item.find("a.level").attr("level");this.workspace.query.helper.includeLevel(p,n,r,k)}else{j.workspace.query.helper.moveHierarchy(l,p,n,k)}$(m.item).detach();this.workspace.sync_query();j.workspace.query.run();return}return},selections:function(h,g){if(h){h.preventDefault()}var f=$(h.target).hasClass("d_level")?$(h.target).find(".level"):$(h.target);var e=f.attr("href").replace("#","");(new SelectionsModal({target:f,name:f.text(),key:e,workspace:this.workspace})).open();return false},limit_axis:function(i){var j=this;if(typeof this.workspace.query=="undefined"||this.workspace.query.model.type!="QUERYMODEL"||Settings.MODE=="view"){return false}var g=$(i.target).hasClass("limit")?$(i.target):$(i.target).parent();var f=g.siblings(".fields_list_body");var h=f.parent().attr("title");$.contextMenu("destroy",".limit");$.contextMenu({appendTo:g,selector:".limit",ignoreRightClick:true,build:function(ac,O){var Z=j.workspace.query;var U=j.workspace.selected_cube;var Q={};var K=Saiku.session.sessionworkspace.cube[U].get("data").measures;var t=j.workspace.query.helper.getAxis(h);var Y,s,c,a,e,W,n,X,V,aa;var M=false,N=false,S=false;if(t&&t.filters){_.each(t.filters,function(k){if(k.flavour=="N"){Y=t["function"];s=k.expressions[0];c=k.expressions[1];S=true}if(k.flavour=="Generic"){a=k.expressions[0];M=true}})}if(t&&t.sortOrder){e=t.sortOrder;W=t.sortEvaluationLiteral;N=true}if(t&&t.aggregators&&t.aggregators.length>0){aa=t.aggregators[0]}if(Y!=null&&c==null){X=Y+"###SEPARATOR###"+s}else{if(Y!=null&&c!=null&&s!=null){X="custom"}}if(N&&e!=null){n="customsort"}_.each(K,function(k){Q[k.uniqueName]={name:k.caption,payload:{n:10,sortliteral:k.uniqueName}}});var L=function(m,l){var k={};for(d in m){k[(l+"###SEPARATOR###"+d)]=_.clone(m[d]);k[(l+"###SEPARATOR###"+d)].fun=l;if(l==Y&&c==d&&m[d].payload.n==s){X=l+"Quick";k[(l+"###SEPARATOR###"+d)].name="<b>"+m[d].name+"</b>"}if(l==e&&W==d){n=l+"Quick";k[(l+"###SEPARATOR###"+d)].name="<b>"+m[d].name+"</b>"}}return k};var b={filter:{name:"Filter",i18n:true,items:{customfilter:{name:"Custom...",i18n:true},clearfilter:{name:"Clear Filter",i18n:true}}},limit:{name:"Limit",i18n:true,items:{"TopCount###SEPARATOR###10":{name:"Top 10",i18n:true},"BottomCount###SEPARATOR###10":{name:"Bottom 10",i18n:true},TopCountQuick:{name:"Top 10 by...",i18n:true,items:L(Q,"TopCount")},BottomCountQuick:{name:"Bottom 10 by...",i18n:true,items:L(Q,"BottomCount")},customtop:{name:"Custom Limit...",i18n:true},clearlimit:{name:"Clear Limit",i18n:true}}},sort:{name:"Sort",items:{ASCQuick:{name:"Ascending",i18n:true,items:L(Q,"ASC")},DESCQuick:{name:"Descending",i18n:true,items:L(Q,"DESC")},BASCQuick:{name:"Ascending (Breaking Hierarchy)",i18n:true,items:L(Q,"BASC")},BDESCQuick:{name:"Descending (Breaking Hierarchy)",i18n:true,items:L(Q,"BDESC")},customsort:{name:"Custom...",i18n:true},clearsort:{name:"Clear Sort",i18n:true}}},grand_totals:{name:"Grand totals",items:{show_totals_not:{name:"None",i18n:true},show_totals_sum:{name:"Sum",i18n:true},show_totals_min:{name:"Min",i18n:true},show_totals_max:{name:"Max",i18n:true},show_totals_avg:{name:"Avg",i18n:true}}},cancel:{name:"Cancel",i18n:true}};$.each(b,function(k,l){recursive_menu_translate(l,Saiku.i18n.po_file)});var ab=b.grand_totals.items;if(aa){for(var d in ab){if(d.substring("show_totals_".length)==aa){ab[d].name="<b>"+ab[d].name+"</b"}}}else{ab.show_totals_not.name="<b>"+ab.show_totals_not.name+"</b"}Q["10"]={payload:{n:10}};if(M){var P=b.filter;P.name="<b>"+P.name+"</b>";P.items.customfilter.name="<b>"+P.items.customfilter.name+"</b>"}if(N){var R=b.sort.items;b.sort.name="<b>"+b.sort.name+"</b>";if(n in R){R[n].name="<b>"+R[n].name+"</b>"}}if(S){var T=b.limit.items;b.limit.name="<b>"+b.limit.name+"</b>";if(X in T){T[X].name="<b>"+T[X].name+"</b>"}}return{callback:function(m,l){if(m=="cancel"){return}if(m=="clearfilter"){g.removeClass("on");j.workspace.query.helper.removeFilter(t,"Generic");j.synchronize_query();j.workspace.query.run()}else{if(m=="customfilter"){var w=function(z){var A=[];A.push(z);j.workspace.query.helper.removeFilter(t,"Generic");t.filters.push({flavour:"Generic",operator:null,"function":"Filter",expressions:A});j.synchronize_query();j.workspace.query.run()};(new FilterModal({axis:h,success:w,query:j.workspace.query,expression:a,expressionType:"Filter"})).render().open()}else{if(m=="clearlimit"){g.removeClass("on");j.workspace.query.helper.removeFilter(t,"N");j.synchronize_query();j.workspace.query.run()}else{if(m=="customtop"){var w=function(C,z,B){var A=[];A.push(z);if(B){A.push(B)}j.workspace.query.helper.removeFilter(t,"N");t.filters.push({flavour:"N",operator:null,"function":C,expressions:A});j.synchronize_query();j.workspace.query.run()};(new CustomFilterModal({axis:h,measures:K,success:w,query:j.workspace.query,func:Y,n:s,sortliteral:c})).render().open()}else{if(m=="customsort"){var x=function(z,A){t.sortOrder=z;t.sortEvaluationLiteral=A;j.synchronize_query();j.workspace.query.run()};(new FilterModal({axis:h,success:x,query:j.workspace.query,expression:W,expressionType:"Order"})).render().open()}else{if(m=="clearsort"){t.sortOrder=null;t.sortEvaluationLiteral=null;j.synchronize_query();j.workspace.query.run()}else{if(m.indexOf("show_totals_")==0){var o=m.substring("show_totals_".length);var k=[];k.push(o);t.aggregators=k;j.workspace.query.run()}else{var q=m.split("###SEPARATOR###")[0];var u=m.split("###SEPARATOR###")[1];var p="";var v={};if(_.indexOf(["ASC","BASC","DESC","BDESC"],q)>-1){t.sortOrder=q;t.sortEvaluationLiteral=Q[u].payload.sortliteral}else{var r=[];r.push(Q[u].payload.n);var y=Q[u].payload.sortliteral;if(y){r.push(y)}j.workspace.query.helper.removeFilter(t,"N");t.filters.push({flavour:"N",operator:null,"function":q,expressions:r})}j.synchronize_query();j.workspace.query.run()}}}}}}}},items:b}}});g.contextMenu()}});var Table=Backbone.View.extend({className:"table_wrapper",events:{"click th.row":"clicked_cell","click th.col":"clicked_cell"},initialize:function(b){this.workspace=b.workspace;this.renderer=new SaikuTableRenderer();_.bindAll(this,"render","process_data");this.workspace.bind("query:result",this.render);this.id=_.uniqueId("table_");$(this.el).attr("id",this.id)},clicked_cell:function(h){var e=this;if(this.workspace.query.get("type")!="QM"||Settings.MODE=="table"){return false}if($(this.workspace.el).find(".workspace_results.ui-selectable").length>0){$(this.workspace.el).find(".workspace_results").selectable("destroy")}var f=($(h.target).hasClass("row")||$(h.target).hasClass("col"))?$(h.target).find("div"):$(h.target);var g=$(document);$.contextMenu("destroy",".row, .col");$.contextMenu({appendTo:f,selector:".row, .col",ignoreRightClick:true,build:function(aa,K){var W=$(K.currentTarget).find("div");var X=$(K.currentTarget).hasClass("rows")?"ROWS":"COLUMNS";var P=W.attr("rel").split(":");var L=parseInt(P[0]);var T=parseInt(P[1]);var Y=e.workspace.query.result.lastresult().cellset[L][T];var U=e.workspace.query;var c=U.get("schema");var S=U.get("connection")+"/"+U.get("catalog")+"/"+((c==""||c==null)?"null":c)+"/"+U.get("cube");var J=Y.properties.dimension;var N=Y.properties.hierarchy;var R=Y.properties.level;var O="";var d=JSON.stringify({hierarchy:N,uniquename:R,type:"level",action:"delete"})+","+JSON.stringify({hierarchy:N,uniquename:Y.properties.uniquename,type:"member",action:"add"});var ab=Y.properties.uniquename;var M=[];var H={};var I=Saiku.session.sessionworkspace.cube[S];var Q=(I&&I.has("data"))?I.get("data").dimensions:null;if(!Q){Saiku.session.sessionworkspace.cube[S].fetch({async:false});Q=Saiku.session.sessionworkspace.cube[S].get("data").dimensions}var l={};var b=[];e.workspace.query.action.get("/axis/"+X+"/dimension/"+encodeURIComponent(J),{success:function(j,i){l=i},async:false});_.each(l.selections,function(i){if(_.indexOf(b,i.levelUniqueName)==-1){b.push(i.levelUniqueName)}});_.each(Q,function(i){if(i.name==J){_.each(i.hierarchies,function(j){if(j.uniqueName==N){_.each(j.levels,function(k){H[k.name]={name:k.caption,payload:JSON.stringify({hierarchy:N,uniquename:k.uniqueName,type:"level",action:"add"})};if(_.indexOf(b,k.uniqueName)>-1){H[k.name].disabled=true;H["remove-"+k.name]={name:k.caption,payload:JSON.stringify({hierarchy:N,uniquename:k.uniqueName,type:"level",action:"delete"})}}if(k.uniqueName==R){O=k.caption;l_name=k.name}H["keep-"+k.name]=H[k.name];H["include-"+k.name]=JSON.parse(JSON.stringify(H[k.name]));H["keep-"+k.name].payload=d+","+H[k.name].payload})}})}});H.keeponly={payload:d};H.getchildren={payload:ab};if(H.hasOwnProperty("remove-"+l_name)&&H.hasOwnProperty("include-"+l_name)){H.showall={payload:H["remove-"+l_name].payload+", "+H["include-"+l_name].payload}}var V=function(i){var j={};for(key in H){if(i!=null&&i.length<key.length&&key.substr(0,i.length)==i){j[key]=H[key]}}return j};var Z=W.html();var a={name:{name:"<b>"+Z+"</b>",disabled:true},sep1:"---------",keeponly:{name:"Keep Only",i18n:true,payload:d}};if(J!="Measures"){a.getchildren={name:"Show Children",i18n:true,payload:ab};a.fold1key={name:"Include Level",i18n:true,items:V("include-")};a.fold2key={name:"Keep and Include Level",i18n:true,items:V("keep-")};a.fold3key={name:"Remove Level",i18n:true,items:V("remove-")};a.filterlevel={name:"Filter Level",i18n:true};if(H.showall){a.showall={name:"Remove Filters",i18n:true}}}$.each(a,function(j,i){recursive_menu_translate(i,Saiku.i18n.po_file)});return{callback:function(j,k){var m="/axis/"+X+"/dimension/"+encodeURIComponent(J);var i=false;if(j.indexOf("filterlevel")>=0){var j=encodeURIComponent(J)+"/hierarchy/"+encodeURIComponent(N)+"/"+encodeURIComponent(R);(new SelectionsModal({target:null,axis:X,name:O,key:j,workspace:e.workspace})).open();return}if(j.indexOf("children")>=0){m="/axis/"+X+"/dimension/"+encodeURIComponent(J)+"/children";i=true}if(i){e.workspace.query.set({formatter:"flat"})}e.workspace.query.action.put(m,{success:e.workspace.sync_query,dataType:"text",data:i?{member:H[j].payload}:{selections:"["+H[j].payload+"]"}})},items:a}}});f.contextMenu()},render:function(d,c){if(typeof d=="undefined"||typeof d.data=="undefined"||($(this.workspace.el).is(":visible")&&!$(this.el).is(":visible"))){return}if(d.data!=null&&d.data.error!=null){return}if(d.data==null||(d.data.height===0)||d.data.cellset.length===0){return}this.clearOut();$(this.el).html("Rendering "+d.data.width+" columns and "+d.data.height+" rows...");_.delay(this.process_data,2,d.data)},clearOut:function(){this.renderer.clear();$(this.workspace.el).find(".workspace_results").unbind("scroll");var d=document.getElementById(this.id);var c=d.firstChild;if(c){d.removeChild(c)}},process_data:function(c){this.workspace.processing.hide();this.workspace.adjust();this.clearOut();$(this.el).html("<table></table>");var d=this.renderer.render(c,{htmlObject:$(this.el).find("table"),batch:Settings.TABLE_LAZY,batchSize:Settings.TABLE_LAZY_SIZE,batchIntervalSize:Settings.TABLE_LAZY_LOAD_ITEMS,batchIntervalTime:Settings.TABLE_LAZY_LOAD_TIME});this.post_process()},post_process:function(){if(this.workspace.query.get("type")=="QM"&&Settings.MODE!="view"){$(this.el).addClass("headerhighlight")}else{$(this.el).removeClass("headerhighlight")}$(this.el).find(".i18n").i18n(Saiku.i18n.po_file);this.workspace.trigger("table:rendered",this)}});var Workspace=Backbone.View.extend({className:"tab_container",events:{"click .sidebar_separator":"toggle_sidebar","change .cubes":"new_query","drop .sidebar":"remove_dimension","drop .workspace_results":"remove_dimension","click .refresh_cubes":"refresh","click .cancel":"cancel"},initialize:function(b){_.bindAll(this,"caption","adjust","toggle_sidebar","prepare","new_query","init_query","update_caption","populate_selections","refresh","sync_query","cancel","cancelled","no_results","error","switch_view_state");_.extend(this,Backbone.Events);this.loaded=false;this.bind("query:result",this.render_result);this.toolbar=new WorkspaceToolbar({workspace:this});this.toolbar.render();this.upgrade=new Upgrade({workspace:this});this.upgrade.render();this.querytoolbar=new QueryToolbar({workspace:this});this.querytoolbar.render();this.drop_zones=new WorkspaceDropZone({workspace:this});this.drop_zones.render();this.table=new Table({workspace:this});this.chart=new Chart({workspace:this});this.item={};this.viewState=(b&&b.viewState)?b.viewState:Settings.DEFAULT_VIEW_STATE;this.isReadOnly=(Settings.MODE=="view"||false);if(b&&b.item){this.item=b.item;if(this.item&&this.item.hasOwnProperty("acl")&&_.indexOf(this.item.acl,"WRITE")<0){this.isReadOnly=true;this.viewState="view"}}if(!b||(!b.query&&!b.viewState)){this.viewState="edit"}if(b&&b.query){this.query=b.query;this.query.workspace=this;Saiku.ui.block("Loading Query....");this.query.save({},{success:this.init_query,error:function(){Saiku.ui.unblock();if($("body").find(".error_loading_query").length<1){var d=(Saiku.i18n&&Saiku.i18n.po_file.error_loading_query)?Saiku.i18n.po_file.error_loading_query:null;if(!d){d="Error Loading Query";$('<span class="i18n error_loading_query">'+d+"</span>").hide().appendTo("body");Saiku.i18n.translate();d=$(".error_loading_query").text()}alert(d)}else{var a=$(".error_loading_query").text();alert(a)}}})}Saiku.session.bind("tab:add",this.prepare)},caption:function(b){if(this.query&&this.query.model.name){return this.query.model.name}else{if(this.query&&this.query.get("name")){return this.query.get("name")}}if(b){Saiku.tabs.queryCount++}return"<span class='i18n'>Unsaved query</span> ("+(Saiku.tabs.queryCount)+")"},template:function(){var b=$("#template-workspace").html()||"";return _.template(b)({cube_navigation:Saiku.session.sessionworkspace.cube_navigation})},refresh:function(b){if(b){b.preventDefault()}Saiku.session.sessionworkspace.refresh()},render:function(){$(this.el).html(this.template());this.processing=$(this.el).find(".query_processing");if(this.isReadOnly||Settings.MODE&&(Settings.MODE=="view"||Settings.MODE=="table")){$(this.el).find(".workspace_editor").remove();this.toggle_sidebar();$(this.el).find(".sidebar_separator").remove();$(this.el).find(".workspace_inner").css({"margin-left":0});$(this.el).find(".workspace_fields").remove();$(this.el).find(".sidebar").hide();$(this.toolbar.el).find(".run, .auto, .toggle_fields, .toggle_sidebar,.switch_to_mdx, .new").parent().remove()}else{$(this.el).find(".workspace_editor").append($(this.drop_zones.el));$(this.el).find(".sidebar").droppable({accept:".d_measure, .selection"});$(this.el).find(".workspace_results").droppable({accept:".d_measure, .selection"})}if(Settings.MODE&&Settings.MODE=="table"){$(this.el).find(".workspace_toolbar").remove();$(this.el).find(".query_toolbar").remove()}else{$(this.el).find(".workspace_toolbar").append($(this.toolbar.el));$(this.el).find(".query_toolbar").append($(this.querytoolbar.el));$(this.el).find(".upgrade").append($(this.upgrade.el))}this.switch_view_state(this.viewState,true);$(this.el).find(".workspace_results").append($(this.table.el));this.chart.render_view();this.tab.bind("tab:select",this.adjust);$(window).resize(this.adjust);Saiku.session.trigger("workspace:new",{workspace:this});Saiku.i18n.translate(this.el);return this},clear:function(){this.table.clearOut();$(this.el).find(".workspace_results table,.connectable").html("");$(this.el).find(".workspace_results_info").empty();$(this.el).find(".parameter_input").empty();$(this.chart.el).find("div.canvas").empty();$(this.querytoolbar.el).find("ul.options a.on").removeClass("on");$(this.el).find('.fields_list[title="ROWS"] .limit').removeClass("on");$(this.el).find('.fields_list[title="COLUMNS"] .limit').removeClass("on");Saiku.session.trigger("workspace:clear",{workspace:this})},adjust:function(){var j=$(this.el).find(".sidebar_separator");var i=87;if(Settings.PLUGIN==true||Settings.BIPLUGIN==true){i=2;if(Settings.MODE=="table"){i=-5}}if($("#header").length==0||$("#header").is("hidden")){i=2}j.height($("body").height()-i);$(this.el).find(".sidebar").height($("body").height()-i);$(this.querytoolbar.el).find("div").height($("body").height()-i-10);var g=$(this.el).find(".workspace_editor").is(":hidden")?0:$(this.el).find(".workspace_editor").height();var h=$(this.el).find(".query_processing").is(":hidden")?0:$(this.el).find(".query_processing").height()+62;var f=$(this.el).find(".upgradeheader").is(":hidden")?0:$(this.el).find(".upgrade").height();$(this.el).find(".workspace_results").css({height:$("body").height()-i-$(this.el).find(".workspace_toolbar").height()-$(this.el).find(".workspace_results_info").height()-g-h-f-20});if(this.querytoolbar){$(this.querytoolbar.el).find("a").tipsy({delayIn:700,fade:true})}if(this.toolbar){$(this.toolbar.el).find("a").tipsy({delayIn:900,fade:true})}this.trigger("workspace:adjust",{workspace:this})},toggle_sidebar:function(){$(this.el).find(".sidebar").toggleClass("hide");$(this.toolbar.el).find(".toggle_sidebar").toggleClass("on");var d=($(this.el).find(".sidebar").is(":visible")?$(this.el).find(".sidebar").width():0)+($(this.el).find(".sidebar_separator").width())+1;var c=d;$(this.el).find(".workspace_inner").css({"margin-left":c})},prepare:function(){$(this.el).find(".cubes").parent().css({backgroundColor:"#AC1614"}).delay(300).animate({backgroundColor:"#fff"},"slow")},new_query:function(){if(this.query){this.query.destroy();this.query.clear();if(this.query.name){this.query.name=undefined;this.update_caption(true)}this.query.name=undefined}this.clear();this.processing.hide();Saiku.session.trigger("workspace:clear",{workspace:this});this.selected_cube=$(this.el).find(".cubes").val();if(!this.selected_cube){$(this.el).find(".calculated_measures, .addMeasure").hide();$(this.el).find(".dimension_tree").html("");$(this.el).find(".measure_tree").html("");return false}this.metadata=Saiku.session.sessionworkspace.cube[this.selected_cube];var g=this.selected_cube.split("/");var e=g[3];for(var h=4,f=g.length;h<f;h++){e+="/"+g[h]}this.query=new Query({cube:{connection:g[0],catalog:g[1],schema:(g[2]=="null"?"":g[2]),name:decodeURIComponent(e)}},{workspace:this});this.query.save({},{data:{json:JSON.stringify(this.query.model)},async:false});this.init_query()},init_query:function(j){var e=this;Saiku.ui.unblock();try{var p=this.query.model.properties?this.query.model.properties:{};var k=("RENDER_MODE" in Settings)?Settings.RENDER_MODE:("saiku.ui.render.mode" in p)?p["saiku.ui.render.mode"]:null;var o=("RENDER_TYPE" in Settings)?Settings.RENDER_TYPE:("saiku.ui.render.type" in p)?p["saiku.ui.render.type"]:null;if(typeof k!="undefined"&&k!=null){this.querytoolbar.switch_render(k)}if("chart"==k){$(this.chart.el).find(".canvas_wrapper").hide();this.chart.renderer.switch_chart(o);$(this.querytoolbar.el).find('ul.chart [href="#'+o+'"]').parent().siblings().find(".on").removeClass("on");$(this.querytoolbar.el).find('ul.chart [href="#'+o+'"]').addClass("on")}else{if("table"==k&&o in this.querytoolbar){this.querytoolbar.render_mode="table";this.querytoolbar.spark_mode=o;$(this.querytoolbar.el).find("ul.table a."+o).addClass("on")}}}catch(m){Saiku.error(this.cid,m)}if((Settings.MODE=="table")&&this.query){this.query.run(true);return}if(this.query.model.type=="MDX"){this.query.setProperty("saiku.olap.result.formatter","flat");if(!$(this.el).find(".sidebar").hasClass("hide")){this.toggle_sidebar()}$(this.el).find(".workspace_fields").addClass("hide");this.toolbar.switch_to_mdx()}else{$(this.el).find(".workspace_editor").removeClass("hide").show();$(this.el).find(".workspace_fields").removeClass("disabled").removeClass("hide");$(this.el).find(".workspace_editor .mdx_input").addClass("hide");$(this.el).find(".workspace_editor .editor_info").addClass("hide");$(this.toolbar.el).find(".auto, .toggle_fields, .query_scenario, .buckets, .non_empty, .swap_axis, .mdx, .switch_to_mdx, .zoom_mode, .drillacross").parent().show();$(this.el).find(".run").attr("href","#run_query")}this.adjust();this.switch_view_state(this.viewState,true);if(!$(this.el).find(".sidebar").hasClass("hide")&&(Settings.MODE=="table"||Settings.MODE=="view"||this.isReadOnly)){this.toggle_sidebar()}if((Settings.MODE=="view")&&this.query||this.isReadOnly){this.query.run(true);return}if(this.selected_cube===undefined){var n=this.query.model.cube.schema;this.selected_cube=this.query.model.cube.connection+"/"+this.query.model.cube.catalog+"/"+((n==""||n==null)?"null":n)+"/"+encodeURIComponent(this.query.model.cube.name);$(this.el).find(".cubes").val(this.selected_cube)}if(this.selected_cube){var l=Saiku.session.sessionworkspace.cube[this.selected_cube];this.dimension_list=new DimensionList({workspace:this,cube:l});this.dimension_list.render();$(this.el).find(".metadata_attribute_wrapper").html("").append($(this.dimension_list.el));if(!l.has("data")){l.fetch({success:function(){e.trigger("cube:loaded")}})}this.trigger("query:new",{workspace:this})}else{$(this.el).find(".calculated_measures, .addMeasure").hide();$(this.el).find(".dimension_tree").html("");$(this.el).find(".measure_tree").html("")}if(typeof j!="undefined"){this.query.run(true)}Saiku.i18n.translate()},synchronize_query:function(){var b=this;if(!b.isReadOnly&&(!Settings.hasOwnProperty("MODE")||(Settings.MODE!="table"&&Settings.MODE!="view"))){}},sync_query:function(i){var l=this.query.helper.model();if(l.type==="QUERYMODEL"){var h=this;var k=i?i:$(h.dimension_list.el);if(!h.isReadOnly&&(!Settings.hasOwnProperty("MODE")||(Settings.MODE!="table"&&Settings.MODE!="view"))){k.find(".selected").removeClass("selected");var g=h.query.helper.getCalculatedMeasures();if(g&&g.length>0){var j=_.template($("#template-calculated-measures").html(),{measures:g});k.find(".calculated_measures").html(j);k.find(".calculated_measures").find(".measure").parent("li").draggable({cancel:".not-draggable",connectToSortable:$(h.el).find(".fields_list_body.details ul.connectable"),helper:"clone",placeholder:"placeholder",opacity:0.6,tolerance:"touch",containment:$(h.el),cursorAt:{top:10,left:35}})}h.drop_zones.synchronize_query()}}Saiku.i18n.translate()},populate_selections:function(V){var J=this;console.log("populate_selections");V.workspace.sync_query();return false;if(this.other_dimension){var E=this.query?this.query.get("axes"):false;if(E){for(var P=0,G=E.length;P<G;P++){var S=E[P];var O=$(this.el).find("."+S.name.toLowerCase()+" ul");if((S.filterCondition!=null)||(S.limitFunction&&S.limitFunction!=null&&S.limitFunction!="")||(S.sortOrder!=null)){O.parent().siblings(".fields_list_header").addClass("on")}for(var N=0,F=S.dimensionSelections.length;N<F;N++){var B=S.dimensionSelections[N];var Q=[];var A={};if(B.name!="Measures"&&B.selections.length>0){var I=Saiku.session.sessionworkspace.cube[this.selected_cube].get("data").dimensions;var D=B.selections[0].hierarchyUniqueName;_.each(I,function(a){if(B.name==a.name){_.each(a.hierarchies,function(c){if(c.uniqueName==D){var b=[];_.each(c.levels,function(d){b.push(d.uniqueName)});B.selections=_.sortBy(B.selections,function(d){return _.indexOf(b,d.levelUniqueName)})}})}})}else{if(B.name=="Measures"&&B.selections.length>0){var H=Saiku.session.sessionworkspace.cube[this.selected_cube].get("data").measures;var T=[];_.each(H,function(a){T.push(a.uniqueName)});B.selections=_.sortBy(B.selections,function(a){return _.indexOf(T,a.uniqueName)})}}for(var L=0,K=B.selections.length;L<K;L++){var h=B.selections[L];var R,z;if(h.dimensionUniqueName=="Measures"){R="measure";z=h.uniqueName}else{R="dimension";z=h.levelUniqueName}if(Q.indexOf(z)===-1){var U=$("");if(typeof dimension_el!="undefined"&&(!U.html()||U.html()==null)){U=$(dimension_el).find('a[rel="'+z+'"]').parent()}if(typeof J.dimension_list!="undefined"&&(!U.html()||U.html()==null)){U=$(J.dimension_list.el).find('a[rel="'+z+'"]').parent()}var M=U.clone().addClass("d_"+R).appendTo(O);if(R=="dimension"){$("<span />").addClass("sprite selections").prependTo(M);$icon=$("<span />").addClass("sort");var C=false;_.each(E,function(a){if(a.sortLiteral&&a.sortLiteral!=null&&a.sortLiteral.indexOf(h.hierarchyUniqueName)!=-1){$icon.addClass(a.sortOrder);C=true}});if(!C){$icon.addClass("none")}$icon.insertBefore(M.find("span"))}if(R=="measure"){$icon=$("<span />").addClass("sort");var C=false;_.each(E,function(a){if(a.sortLiteral&&a.sortLiteral!=null&&a.sortLiteral.indexOf(z)!=-1){$icon.addClass(a.sortOrder);C=true}});if(!C){$icon.addClass("none")}$icon.insertBefore(M.find("a"))}U.css({fontWeight:"bold"}).draggable("disable").parents(".parent_dimension").find(".folder_collapsed").css({fontWeight:"bold"});Q.push(z)}}}}}this.trigger("query:new",{workspace:this});this.query.bind("query:save",this.update_caption)}else{this.other_dimension=dimension_el}},update_caption:function(d){var c=this.caption(d);this.tab.set_caption(c)},remove_dimension:function(d,c){if(this.query.model.type=="QUERYMODEL"){this.drop_zones.remove_dimension(d,c)}},update_parameters:function(){var h=this;if(!Settings.ALLOW_PARAMETERS){return}var j="<span class='i18n'>Parameters</span>: ";var k=this.query.helper.model().parameters;var l=false;for(var g in k){var i="";if(k[g]&&k[g]!=null){i=k[g]}j+="<b>"+g+"</b> <input type='text' placeholder='"+g+"' value='"+i+"' />";l=true}j+="";if(l){$(this.el).find(".parameter_input").html(j)}else{$(this.el).find(".parameter_input").html("")}$(this.el).find(".parameter_input input").off("change");$(this.el).find(".parameter_input input").on("change",function(b){var a=$(b.target).attr("placeholder");var c=$(b.target).val();h.query.helper.model().parameters[a]=c})},render_result:function(m){var h=this;$(this.el).find(".workspace_results_info").empty();if(m.data!=null&&m.data.error!=null){return this.error(m)}if(m.data==null||(m.data.cellset&&m.data.cellset.length===0)){return this.no_results(m)}var i=new Date().getHours();if(i<10){i="0"+i}var j=new Date().getMinutes();if(j<10){j="0"+j}var n=i+":"+j;var l=m.data.runtime!=null?(m.data.runtime/1000).toFixed(2):"";var k='<b><span class="i18n">Info:</span></b> &nbsp;'+n+"&emsp;/ &nbsp;"+m.data.width+" x "+m.data.height+"&nbsp; / &nbsp;"+l+"s";this.update_parameters();$(this.el).find(".workspace_results_info").html(k);this.adjust();return},switch_view_state:function(f,d){var e=f||"edit";if(e=="edit"){this.toolbar.toggle_fields_action("show",d);if(this.query&&this.query.get("type")=="MDX"){this.toolbar.editor.gotoLine(0)}if($(this.el).find(".sidebar").hasClass("hide")){this.toggle_sidebar()}$(this.toolbar.el).find(".auto, .toggle_fields, .toggle_sidebar,.switch_to_mdx, .new").parent().css({display:"block"})}else{if(e=="view"){this.toolbar.toggle_fields_action("hide",d);if(!$(this.el).find(".sidebar").hasClass("hide")){this.toggle_sidebar()}$(this.toolbar.el).find(".auto, .toggle_fields, .toggle_sidebar,.switch_to_mdx").parent().hide()}}this.viewState=e;$(window).trigger("resize")},block:function(b){$(this.el).block({message:'<span class="saiku_logo" style="float:left">&nbsp;&nbsp;</span> '+b});Saiku.i18n.translate()},unblock:function(){if(isIE){Saiku.ui.unblock()}else{$(this.el).unblock();Saiku.ui.unblock()}},cancel:function(c){var d=this;if(c){c.preventDefault()}this.query.action.del("/cancel",{success:function(){d.cancelled()}})},cancelled:function(b){this.processing.html('<span class="processing_image">&nbsp;&nbsp;</span> <span class="i18n">Canceling Query...</span>').show()},no_results:function(b){this.processing.html('<span class="i18n">No Results</span>').show()},error:function(b){this.processing.html(safe_tags_replace(b.data.error)).show()}});var DeleteRepositoryObject=Modal.extend({type:"delete",buttons:[{text:"Yes",method:"del"},{text:"No",method:"close"}],initialize:function(b){this.options.title="Confirm deletion";this.query=b.query;this.success=b.success;this.message=_.template("Are you sure you want to delete <%= name %>?")({name:this.query.get("name")})},del:function(){this.query.id=_.uniqueId("query_");this.query.url=this.query.url()+"?file="+encodeURIComponent(this.query.get("file"));this.query.destroy({success:this.success,dataType:"text",error:this.error});this.close()},error:function(){$(this.el).find("dialog_body").html("Could not delete repository object")}});var OpenQuery=Backbone.View.extend({className:"tab_container",events:{"click .query":"view_query","dblclick .query":"select_and_open_query","click .add_folder":"add_folder","click li.folder":"toggle_folder","click .workspace_toolbar a.button":"prevent_default","click .workspace_toolbar a.open":"open_query","click .workspace_toolbar a.edit":"edit_query","click .workspace_toolbar [href=#edit_folder]":"edit_folder","click .workspace_toolbar [href=#delete_folder]":"delete_repoObject","click .workspace_toolbar [href=#delete_query]":"delete_repoObject","click .workspace_toolbar [href=#edit_permissions]":"edit_permissions","click .queries":"click_canvas","keyup .search_file":"search_file","click .cancel_search":"cancel_search"},template:function(){return _.template($("#template-open-dialog").html())()},template_repository_objects:function(c){var d=this;$(this.el).find(".sidebar ul").html(_.template($("#template-repository-objects").html())({repoObjects:c}))},caption:function(){return"Repository"},render:function(){$(this.el).html(this.template());this.tab.bind("tab:select",this.fetch_queries);this.tab.bind("tab:select",this.adjust);$(window).resize(this.adjust);var d=this;var c={open:{name:"Open",i18n:true},edit:{name:"Edit",i18n:true},"delete":{name:"Delete",i18n:true},sep1:"---------","new":{name:"New Folder",i18n:true}};$.each(c,function(b,a){recursive_menu_translate(a,Saiku.i18n.po_file)});$.contextMenu("destroy","li.query, div.folder_row");$.contextMenu({selector:"li.query, div.folder_row",events:{show:function(f){$(d.el).find(".selected").removeClass("selected");$(this).addClass("selected");var a=$(this).find("a").attr("href").replace("#","");var b=d.queries[a];if(typeof b.acl!="undefined"&&_.indexOf(b.acl,"WRITE")<0){f.commands["delete"].disabled=true;f.items["delete"].disabled=true;f.commands.edit.disabled=true;f.items.edit.disabled=true}else{f.commands["delete"].disabled=false;f.items["delete"].disabled=false;f.commands.edit.disabled=false;f.items.edit.disabled=false}if($(this).hasClass("folder_row")){f.commands.open.disabled=true;f.items.open.disabled=true}else{f.commands.open.disabled=false;f.items.open.disabled=false}}},callback:function(g,h){var a=$(this).find("a").attr("href").replace("#","");var b=d.queries[a];d.selected_query=new SavedQuery({file:a,name:b.name,type:b.type});if(g=="open"&&$(this).hasClass("query")){d.open_query()}if(g=="edit"&&$(this).hasClass("query")){d.edit_query()}else{if(g=="new"){d.add_folder()}else{if(g=="delete"){d.delete_repoObject()}}}},items:c});return this},initialize:function(b){_.bindAll(this,"adjust","fetch_queries","clear_query","select_and_open_query","cancel_search","add_folder");this.repository=new Repository({},{dialog:this})},fetch_queries:function(){this.repository.fetch()},populate:function(f){var e=this;e.template_repository_objects(f);e.queries={};function d(a){_.forEach(a,function(b){e.queries[b.path]=b;if(b.type==="FOLDER"){d(b.repoObjects)}})}d(f)},search_file:function(d){var e=$(this.el).find(".search_file").val().toLowerCase();var f=(typeof e=="undefined"||e==""||e==null);if(f||d.which==27||d.which==9){this.cancel_search()}else{if($(this.el).find(".search_file").val()){$(this.el).find(".cancel_search").show()}else{$(this.el).find(".cancel_search").hide()}$(this.el).find("li.query").removeClass("hide");$(this.el).find("li.query a").each(function(a){if($(this).text().toLowerCase().indexOf(e)==-1){$(this).parent("li.query").addClass("hide")}});$(this.el).find("li.folder").addClass("hide");$(this.el).find("li.query").not(".hide").parents("li.folder").removeClass("hide");$(this.el).find("li.folder .folder_row").find(".sprite").removeClass("collapsed");$(this.el).find("li.folder .folder_content").removeClass("hide")}return false},cancel_search:function(b){$(this.el).find("input.search_file").val("");$(this.el).find(".cancel_search").hide();$(this.el).find("li.query, li.folder").removeClass("hide");$(this.el).find(".folder_row").find(".sprite").addClass("collapsed");$(this.el).find("li.folder .folder_content").addClass("hide");$(this.el).find(".search_file").val("").focus();$(this.el).find(".cancel_search").hide()},view_query:function(z){z.preventDefault();var e=$(z.currentTarget);var w=e.find("a");this.unselect_current_selected();e.addClass("selected");var o=w.attr("href").replace("#","");var y=w.text();var r=this.queries[o];$(this.el).find(".workspace_toolbar").removeClass("hide");$(this.el).find(".for_queries").addClass("hide");$(this.el).find(".for_folder").addClass("hide");$(this.el).find(".add_folder").parent().addClass("hide");if(typeof r.acl!="undefined"&&_.indexOf(r.acl,"READ")>-1){$(this.el).find(".for_queries .open").parent().removeClass("hide")}if(typeof r.acl!="undefined"&&_.indexOf(r.acl,"WRITE")>-1){$(this.el).find(".for_queries .delete").parent().removeClass("hide");$(this.el).find(".for_queries .edit").parent().removeClass("hide")}if(typeof r.acl!="undefined"&&_.indexOf(r.acl,"GRANT")>-1){$(this.el).find(".for_queries .edit_permissions").parent().removeClass("hide")}try{var t=o.split("/");if(t.length>1){var u=t.splice(0,t.length-1).join("/");var x=this.queries[u];if(typeof x.acl!="undefined"&&_.indexOf(x.acl,"WRITE")>-1){$(this.el).find(".add_folder").parent().removeClass("hide")}}else{if(t.length==1){$(this.el).find(".add_folder").parent().removeClass("hide")}}}catch(s){}var p=$(this.el).find(".workspace_results").html("<h3><strong>"+r.name+"</strong></h3>");var v=$('<ul id="query_info" />').appendTo(p);for(var q in r){if(r.hasOwnProperty(q)&&q!="name"){v.append($("<li />").html("<strong>"+q+"</strong> : "+r[q]))}}this.selected_query=new SavedQuery({file:o,name:y,type:r.type});return false},view_folder:function(i){var g=$(i.currentTarget).children("div").children("a");var h=g.attr("href").replace("#","");var f=g.text();var j=this.queries[h];$(this.el).find(".workspace_toolbar").removeClass("hide");$(this.el).find(".add_folder").parent().addClass("hide");$(this.el).find(".for_queries").addClass("hide");$(this.el).find(".for_folder").addClass("hide");if(typeof j.acl!="undefined"&&_.indexOf(j.acl,"WRITE")>-1){$(this.el).find(".for_folder .delete").parent().removeClass("hide");$(this.el).find(".add_folder").parent().removeClass("hide")}if(typeof j.acl!="undefined"&&_.indexOf(j.acl,"GRANT")>-1){$(this.el).find(".for_folder .edit_permissions").parent().removeClass("hide")}$(this.el).find(".workspace_results").html("<h3><strong>"+f+"</strong></h3>");this.selected_query=new SavedQuery({file:h,name:f,type:j.type})},prevent_default:function(b){b.preventDefault();return false},add_folder:function(e){$selected=$(this.el).find(".selected");var g="";if(typeof $selected!=="undefined"&&$selected){if($selected.hasClass("folder_row")){g=$selected.children("a").attr("href");g=g.length>1?g.substring(1,g.length):g;g+="/"}else{if($selected.hasClass("query")&&!$selected.parent().hasClass("RepositoryObjects")){var h=$selected.find("a");g=h.attr("href");var f=h.text();g=g.substring(1,g.length-f.length)}}}(new AddFolderModal({path:g,success:this.clear_query})).render().open();return false},click_canvas:function(c){var d=$(c.currentTarget);if(d.hasClass("sidebar")){$(this.el).find(".selected").removeClass("selected")}$(this.el).find(".add_folder").parent().removeClass("hide");return false},toggle_folder:function(h){var e=$(h.currentTarget);this.unselect_current_selected();e.children(".folder_row").addClass("selected");var f=e.children(".folder_content");var g=e.children(".folder_row").find(".sprite").hasClass("collapsed");if(g){e.children(".folder_row").find(".sprite").removeClass("collapsed");f.removeClass("hide")}else{e.children(".folder_row").find(".sprite").addClass("collapsed");f.addClass("hide")}this.view_folder(h);return false},select_and_open_query:function(h){var f=$(h.currentTarget).find("a");var g=f.attr("href").replace("#","");var e=f.text();this.selected_query=new SavedQuery({file:g,name:g});this.open_query()},open_query:function(h){Saiku.ui.block("Opening query...");var l=this.queries[this.selected_query.get("file")];var i=_.extend({file:this.selected_query.get("file"),formatter:Settings.CELLSET_FORMATTER},Settings.PARAMS);var j=new Query(i,{name:this.selected_query.get("name")});var k=null;if(h&&!h.hasOwnProperty("currentTarget")){k=h}var g=Saiku.tabs.add(new Workspace({query:j,item:l,viewState:k}));return false},edit_query:function(){this.open_query("edit")},delete_repoObject:function(b){(new DeleteRepositoryObject({query:this.selected_query,success:this.clear_query})).render().open();return false},edit_folder:function(b){alert("todo: edit folder properties/permissions");return false},edit_permissions:function(b){(new PermissionsModal({workspace:this.workspace,title:"<span class='i18n'>Permissions</span>",file:this.selected_query.get("file")})).open()},clear_query:function(){$(this.el).find(".workspace_toolbar").addClass("hide");$(this.el).find(".workspace_results").html("");this.fetch_queries()},adjust:function(){$separator=$(this.el).find(".sidebar_separator");$separator.height($("body").height()-87);$(this.el).find(".sidebar").css({width:300,height:$("body").height()-87});$(this.el).find(".workspace_inner").css({"margin-left":305});$(this.el).find(".workspace").css({"margin-left":-305});$(this.el).find(".workspace_results").css({width:$(document).width()-$(this.el).find(".sidebar").width()-30,height:$(document).height()-$("#header").height()-$(this.el).find(".workspace_toolbar").height()-$(this.el).find(".workspace_fields").height()-40})},toggle_sidebar:function(){$(this.el).find(".sidebar").toggleClass("hide");var b=$(this.el).find(".sidebar").hasClass("hide")?5:265;$(this.el).find(".workspace_inner").css({"margin-left":b})},unselect_current_selected:function(){$(this.el).find(".selected").removeClass("selected")}});var SaveQuery=Modal.extend({type:"save",closeText:"Save",events:{click:"select_root_folder","click .dialog_footer a":"call","submit form":"save","click .query":"select_name","click li.folder":"toggle_folder","keyup .search_file":"search_file","click .cancel_search":"cancel_search"},buttons:[{text:"Save",method:"save"},{text:"Cancel",method:"close"}],folder_name:null,file_name:null,initialize:function(j){var g=this;var f="";var i="";if(j.query.name){var i=j.query.name;var h=j.query.name.split("/");f=h[h.length-1];this.file_name=f;if(h.length>1){this.folder_name=h.splice(0,h.length-1).join("/")}}this.query=j.query;this.message=_.template("<div style=\"height:25px; line-height:25px;\"><b><span class=\"i18n\">Search:</span></b> &nbsp; <span class=\"search\"><input type=\"text\" class=\"search_file\"></input><span class=\"cancel_search\"></span></span></div><form id='save_query_form'><div class='RepositoryObjects'><span class='i18n'>Loading...</span></div><br /><label for='name' class='i18n'>File:</label>&nbsp;<input type='text' name='name' value='<%= name %>' /> <span class='save sprite'></span></form>")({name:i});_.extend(this.options,{title:"Save query"});this.repository=new Repository({},{dialog:this});this.bind("open",function(){var a=($("body").height()/2)+($("body").height()/6);if(a>420){a=420}$(this.el).find(".RepositoryObjects").height(a);$(this.el).dialog("option","position","center");$(this.el).parents(".ui-dialog").css({width:"550px"});g.repository.fetch()});_.bindAll(this,"copy_to_repository","close","toggle_folder","select_name","populate","set_name","cancel_search");if(isIE&&isIE<9){$(this.el).find("form").on("submit",this.save)}},populate:function(b){$(this.el).find(".RepositoryObjects").html(_.template($("#template-repository-objects").html())({repoObjects:b}))},select_root_folder:function(c){var d=$(c.target).attr("name")==="name";if(!d){this.unselect_current_selected_folder()}},toggle_folder:function(i){var j=$(i.currentTarget);this.unselect_current_selected_folder();j.children(".folder_row").addClass("selected");var f=j.find("a").attr("href").replace("#","");this.set_name(f,null);var g=j.children(".folder_content");var h=j.children(".folder_row").find(".sprite").hasClass("collapsed");if(h){j.children(".folder_row").find(".sprite").removeClass("collapsed");g.removeClass("hide")}else{j.children(".folder_row").find(".sprite").addClass("collapsed");g.addClass("hide")}return false},set_name:function(f,d){if(f!=null){this.folder_name=f;var e=(this.folder_name!=null?this.folder_name+"/":"")+(this.file_name!=null?this.file_name:"");$(this.el).find('input[name="name"]').val(e)}if(d!=null){$(this.el).find('input[name="name"]').val(d)}},search_file:function(d){var e=$(this.el).find(".search_file").val().toLowerCase();var f=(typeof e=="undefined"||e==""||e==null);if(f||d.which==27||d.which==9){this.cancel_search()}else{if($(this.el).find(".search_file").val()){$(this.el).find(".cancel_search").show()}else{$(this.el).find(".cancel_search").hide()}$(this.el).find("li.query").removeClass("hide");$(this.el).find("li.query a").filter(function(a){return $(this).text().toLowerCase().indexOf(e)==-1}).parent().addClass("hide");$(this.el).find("li.folder").addClass("hide");$(this.el).find("li.query").not(".hide").parents("li.folder").removeClass("hide");$(this.el).find("li.folder .folder_row").find(".sprite").removeClass("collapsed");$(this.el).find("li.folder .folder_content").removeClass("hide")}return false},cancel_search:function(b){$(this.el).find("input.search_file").val("");$(this.el).find(".cancel_search").hide();$(this.el).find("li.query, li.folder").removeClass("hide");$(this.el).find(".folder_row").find(".sprite").addClass("collapsed");$(this.el).find("li.folder .folder_content").addClass("hide");$(this.el).find(".search_file").val("").focus();$(this.el).find(".cancel_search").hide()},select_name:function(f){var e=$(f.currentTarget);this.unselect_current_selected_folder();e.parent().parent().has(".folder").children(".folder_row").addClass("selected");var d=e.find("a").attr("href").replace("#","");this.set_name(null,d);return false},unselect_current_selected_folder:function(){$(this.el).find(".selected").removeClass("selected")},save:function(f){var e="";var d=$(this.el).find('input[name="name"]').val();if(d!=null&&d.length>0){this.query.set({name:d,folder:e});this.query.trigger("query:save");this.copy_to_repository()}else{alert("You need to enter a name!")}f.preventDefault();return false},copy_to_repository:function(){var f=this;var g=this.query.get("folder");var h=this.query.get("name");h=h.length>6&&h.indexOf(".saiku")==h.length-6?h:h+".saiku";h=g+h;var e=function(b,a,c){if(a&&a.status==403&&a.responseText){alert(a.responseText)}else{f.close()}return true};(new SavedQuery({name:this.query.get("name"),file:h,content:JSON.stringify(this.query.model)})).save({},{success:this.close,error:e,dataType:"text"})}});var OpenDialog=Modal.extend({type:"save",closeText:"Open",events:{click:"select_root_folder","click .dialog_footer a":"call","click .query":"select_name","dblclick .query":"open_query","click li.folder":"toggle_folder","keyup .search_file":"search_file","click .cancel_search":"cancel_search","click .export_btn":"export_zip","change .file":"select_file"},buttons:[{id:"test",text:"Open",method:"open_query"},{text:"Cancel",method:"close"}],initialize:function(f){var e=this;var d="";this.message='<div style="height:25px; line-height:25px;"><b><span class="i18n">Search:</span></b> &nbsp; <span class="search"><input type="text" class="search_file"></input><span class="cancel_search"></span></span></div><div class=\'RepositoryObjects\'>Loading....</div><br><b><div class=\'query_name\'><span class=\'i18n\'>Please select a file.....</span></div></b><br><br>';if(Settings.ALLOW_IMPORT_EXPORT){this.message+="<span class='export_zip'> </span> <b><span class='i18n'>Import or Export Files for Folder</span>: </b> <span class='i18n zip_folder'>< Select Folder... ></span> &nbsp; <input type='submit' value='Export' class='export_btn' disabled /><br/><br /><br /><form id='importForm' target='_blank' method='POST' enctype='multipart/form-data'><input type='hidden' name='directory' class='directory'/><input type='file' name='file' class='file'/><input type='submit' value='Import' class='import_btn' disabled /></form>"}_.extend(this.options,{title:"Open"});this.selected_folder=null;this.repository=new Repository({},{dialog:this});this.bind("open",function(){var a=($("body").height()/2)+($("body").height()/6);if(a>420){a=420}$(this.el).find(".RepositoryObjects").height(a);$(this.el).dialog("option","position","center");$(this.el).parents(".ui-dialog").css({width:"550px"});$(this.el).find(".dialog_footer").find('a[href="#open_query"]').hide();e.repository.fetch()});_.bindAll(this,"close","toggle_folder","select_name","populate","cancel_search","export_zip","select_folder","select_file")},populate:function(f){var e=this;$(this.el).find(".RepositoryObjects").html(_.template($("#template-repository-objects").html())({repoObjects:f}));e.queries={};function d(a){_.forEach(a,function(b){e.queries[b.path]=b;if(b.type==="FOLDER"){d(b.repoObjects)}})}d(f)},select_root_folder:function(c){var d=$(c.target).attr("name")==="name";if(!d){this.unselect_current_selected_folder()}},toggle_folder:function(h){var e=$(h.currentTarget);this.unselect_current_selected_folder();e.children(".folder_row").addClass("selected");var f=e.children(".folder_content");var g=e.children(".folder_row").find(".sprite").hasClass("collapsed");if(g){e.children(".folder_row").find(".sprite").removeClass("collapsed");f.removeClass("hide")}else{e.children(".folder_row").find(".sprite").addClass("collapsed");f.addClass("hide")}this.select_folder();return false},select_name:function(f){var e=$(f.currentTarget);this.unselect_current_selected_folder();e.parent().parent().has(".folder").children(".folder_row").addClass("selected");var d=e.find("a").attr("href");d=d.replace("#","");$(this.el).find(".query_name").html(d);$(this.el).find(".dialog_footer").find('a[href="#open_query"]').show();this.select_folder();return false},unselect_current_selected_folder:function(){$(this.el).find(".selected").removeClass("selected")},search_file:function(d){var e=$(this.el).find(".search_file").val().toLowerCase();var f=(typeof e=="undefined"||e==""||e==null);if(f||d.which==27||d.which==9){this.cancel_search()}else{if($(this.el).find(".search_file").val()){$(this.el).find(".cancel_search").show()}else{$(this.el).find(".cancel_search").hide()}$(this.el).find("li.query").removeClass("hide");$(this.el).find("li.query a").filter(function(a){return $(this).text().toLowerCase().indexOf(e)==-1}).parent().addClass("hide");$(this.el).find("li.folder").addClass("hide");$(this.el).find("li.query").not(".hide").parents("li.folder").removeClass("hide");$(this.el).find("li.folder .folder_row").find(".sprite").removeClass("collapsed");$(this.el).find("li.folder .folder_content").removeClass("hide")}return false},cancel_search:function(b){$(this.el).find("input.search_file").val("");$(this.el).find(".cancel_search").hide();$(this.el).find("li.query, li.folder").removeClass("hide");$(this.el).find(".folder_row").find(".sprite").addClass("collapsed");$(this.el).find("li.folder .folder_content").addClass("hide");$(this.el).find(".search_file").val("").focus();$(this.el).find(".cancel_search").hide()},export_zip:function(f){var d=this.selected_folder;if(typeof d!="undefined"&&d!=""){var e=Settings.REST_URL+(new RepositoryZipExport({directory:d})).url();window.open(e+"?directory="+d+"&type=saiku")}},select_folder:function(){var g=$(this.el).find(".selected");var e=g.length>0?g.children("a").attr("href").replace("#",""):null;if(typeof e!="undefined"&&e!=null&&e!=""){var h=$("#importForm");h.find(".directory").val(e);var f=Settings.REST_URL+(new RepositoryZipExport()).url()+"upload";h.attr("action",f);$(this.el).find(".zip_folder").text(e);this.selected_folder=e;$(this.el).find(".export_btn, .import_btn").removeAttr("disabled");this.select_file()}else{$(this.el).find(".import_btn, .export_btn").attr("disabled","true")}},select_file:function(){var c=$("#importForm");var d=c.find(".file").val();if(typeof d!="undefined"&&d!=""&&d!=null&&this.selected_folder!=null){$(this.el).find(".import_btn").removeAttr("disabled")}else{$(this.el).find(".import_btn").attr("disabled","true")}},open_query:function(m){var j=$(m.currentTarget);var i=$(this.el).find(".query_name").html();if(j.hasClass("query")){i=j.find("a").attr("href").replace("#","")}var o=new SavedQuery({file:i});this.close();Saiku.ui.block("Opening query...");var n=this.queries[i];var k=_.extend({file:i,formatter:Settings.CELLSET_FORMATTER},Settings.PARAMS);var l=new Query(k,{name:i});var p=Saiku.tabs.add(new Workspace({query:l,item:n}));m.preventDefault();return false}});var Tab=Backbone.View.extend({tagName:"li",events:{"click a":"select","mousedown a":"remove","click .close_tab":"remove"},template:function(){return _.template("<a class='saikutab' href='#<%= id %>'><%= caption %></a><span class='close_tab sprite'>Close tab</span>")({id:this.id,caption:this.caption})},initialize:function(b){_.extend(this,Backbone.Events);_.extend(this,b);this.content.tab=this;this.caption=this.content.caption();this.id=_.uniqueId("tab_")},render:function(){var d=this;this.content.render();$(this.el).html(this.template());var c={"new":{name:"New",i18n:true},closethis:{name:"Close This",i18n:true},closeothers:{name:"Close Others",i18n:true}};$.each(c,function(b,a){recursive_menu_translate(a,Saiku.i18n.po_file)});$.contextMenu("destroy",".saikutab");$.contextMenu({selector:".saikutab",callback:function(g,h){var a=h.$trigger.attr("href").replace("#","");var b=Saiku.tabs.find(a);if(g=="closethis"){b.remove();d.select();return}else{if(g=="new"){Saiku.tabs.new_tab()}else{if(g=="closeothers"){b.select();Saiku.tabs.close_others(b)}}}},items:c});return this},set_caption:function(b){$(this.el).find(".saikutab").html(b)},destroy:function(){if(this.content&&this.content.query){this.content.query.destroy()}},select:function(){var b=this;this.parent.select(this);$(this.el).addClass("selected");this.trigger("tab:select");return false},remove:function(d){if(!d||d.which===2||$(d.target).hasClass("close_tab")){this.parent.remove(this);try{$(this.el).remove();this.destroy()}catch(c){Log.log(JSON.stringify({Message:"Tab could not be removed",Tab:JSON.stringify(this)}))}}return false}});var TabPager=Backbone.View.extend({className:"pager_contents",events:{"click a":"select"},initialize:function(b){this.tabset=b.tabset;$(this.el).hide().appendTo("body");$(window).click(function(a){if(!$(a.target).hasClass("pager_contents")){$(".pager_contents").hide()}})},render:function(){var d="";for(var f=0,e=this.tabset._tabs.length;f<e;f++){d+="<a href='#"+f+"'>"+this.tabset._tabs[f].caption+"</a><br />"}$(this.el).html(d);$(this.el).find(".i18n").i18n(Saiku.i18n.po_file)},select:function(c){var d=$(c.target).attr("href").replace("#","");this.tabset._tabs[d].select();$(this.el).hide();c.preventDefault();return false}});var TabSet=Backbone.View.extend({className:"tabs",queryCount:0,events:{"click a.pager":"togglePager","click a.new":"new_tab"},_tabs:[],render:function(){$(this.el).html('<a href="#pager" class="pager sprite"></a><ul><li class="newtab"><a class="new">+&nbsp;&nbsp;</a></li></ul>').appendTo($("#header"));this.content=$('<div id="tab_panel">').appendTo($("body"));this.pager=new TabPager({tabset:this});return this},add:function(c){this.queryCount++;var d=new Tab({content:c});this._tabs.push(d);d.parent=this;d.render().select();$(d.el).insertBefore($(this.el).find("ul li.newtab"));Saiku.session.trigger("tab:add",{tab:d});this.pager.render();return d},find:function(f){for(var d=0,e=this._tabs.length;d<e;d++){if(this._tabs[d].id==f){return this._tabs[d]}}return null},select:function(b){$(this.el).find("li").removeClass("selected");this.content.children().detach();this.content.append($(b.content.el))},remove:function(g){if(this._tabs.length==1){this.add(new Workspace())}for(var e=0,f=this._tabs.length;e<f;e++){if(this._tabs[e]==g){this._tabs.splice(e,1);Saiku.session.trigger("tab:remove",{tab:g});this.pager.render();var h=this._tabs[e]?e:(this._tabs.length-1);this._tabs[h].select()}}return true},close_others:function(i){var f=_.indexOf(this._tabs,i);this._tabs[f].select();for(var j=0,g=this._tabs.length;j<g;j++){if(this._tabs[j]!=i){var h=this._tabs[j];h.remove();j--}}},togglePager:function(){$(this.pager.el).toggle();return false},new_tab:function(){this.add(new Workspace());var b=this._tabs.length-1;this._tabs[b].select();return false}});var RepositoryUrl="api/repository";var repoPathUrl=function(){if(Settings.BIPLUGIN){return"pentaho/repository"}return RepositoryUrl};var RepositoryObject=Backbone.Model.extend({url:function(){var b=repoPathUrl()+"/resource";return b}});var RepositoryAclObject=Backbone.Model.extend({url:function(){var b=repoPathUrl()+"/resource/acl";return b},parse:function(b){if(b!="OK"){_.extend(this.attributes,b)}}});var RepositoryZipExport=Backbone.Model.extend({url:function(){var b=repoPathUrl()+"/zip";return b}});var SavedQuery=Backbone.Model.extend({parse:function(b){},url:function(){var b=repoPathUrl()+"/resource";return b},move_query_to_workspace:function(n,o){var q=o;var t=n.get("file");for(var k in Settings){if(k.match("^PARAM")=="PARAM"){var p=k.substring("PARAM".length,k.length);var s=new RegExp("\\$\\{"+p+"\\}","g");var m=new RegExp("\\$\\{"+p.toLowerCase()+"\\}","g");q=q.replace(s,Settings[k]);q=q.replace(m,Settings[k])}}var l=new Query({xml:q,formatter:Settings.CELLSET_FORMATTER},{name:t});var r=Saiku.tabs.add(new Workspace({query:l}))}});var Repository=Backbone.Collection.extend({model:SavedQuery,initialize:function(c,d){if(d&&d.dialog){this.dialog=d.dialog}},parse:function(b){if(this.dialog){this.dialog.populate(b)}},url:function(){var b=repoPathUrl()+"?type=saiku";if(Settings.REPO_BASE){b+="&path="+Settings.REPO_BASE}return b}});var Result=Backbone.Model.extend({result:null,firstRun:false,initialize:function(c,d){this.query=d.query},parse:function(b){this.query.workspace.unblock();this.query.workspace.processing.hide();this.result=b;if(!b.error){this.query.model=_.extend({},b.query)}this.firstRun=true;this.query.workspace.trigger("query:result",{workspace:this.query.workspace,data:b})},hasRun:function(){return this.firstRun},lastresult:function(){return this.result},url:function(){return"api/query/execute"}});var QueryAction=Backbone.Model.extend({initialize:function(c,d){this.query=d.query;this.url=this.query.url},get:function(c,d){this.handle("fetch",c,d)},post:function(c,d){this.handle("save",c,d)},put:function(c,d){this.id=_.uniqueId("queryaction_");this.handle("save",c,d);delete this.id},del:function(c,d){this.id=_.uniqueId("queryaction_");this.handle("delete",c,d);delete this.id},handle:function(f,d,e){this.url=this.query.url()+d;this.attributes=e.data?e.data:{};if(f=="save"){this.save({},e)}else{if(f=="delete"){this.destroy(e)}else{if(f=="fetch"){this.parse=function(){};this.fetch(e)}}}}});var QueryScenario=Backbone.Model.extend({initialize:function(c,d){_.bindAll(this,"attach_listeners","activate","clicked_cell","save_writeback","cancel_writeback","check_input");this.query=d.query},activate:function(){$(this.query.workspace.el).find("td.data").unbind("click").addClass("cellhighlight").click(this.clicked_cell)},attach_listeners:function(b){if(b.workspace.query&&b.workspace.query.properties&&b.workspace.query.properties.properties["org.saiku.connection.scenario"]==="true"&&$(b.workspace.el).find(".query_scenario").hasClass("on")){$(b.workspace.el).find("td.data").click(this.clicked_cell)}},clicked_cell:function(f){var g=$(f.target).hasClass("data")?$(f.target).find("div"):$(f.target);var j=g.attr("alt");var h=g.attr("rel");var i=$("<input type='text' value='"+j+"' />").keyup(this.check_input).blur(this.cancel_writeback);g.html("").append(i);i.focus()},check_input:function(b){if(b.which==13){this.save_writeback(b)}else{if(b.which==27||b.which==9){this.cancel_writeback(b)}}return false},save_writeback:function(e){var f=$(e.target).closest("input");this.set({value:f.val(),position:f.parent().attr("rel")});this.save();var d=f.val();f.parent().text(d)},cancel_writeback:function(d){var c=$(d.target).closest("input");c.parent().text(c.parent().attr("alt"))},parse:function(){this.query.run()},url:function(){return this.query.url()+"/cell/"+this.get("position")+"/"+this.get("value")}});var Query=Backbone.Model.extend({formatter:Settings.CELLSET_FORMATTER,properties:null,initialize:function(c,d){_.extend(this,d);_.bindAll(this,"run");this.uuid="xxxxxxxx-xxxx-xxxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(a){var b=Math.random()*16|0,g=a=="x"?b:(b&3|8);return g.toString(16)}).toUpperCase();this.model=_.extend({name:this.uuid},SaikuOlapQueryTemplate);if(c.cube){this.model.cube=c.cube}this.helper=new SaikuOlapQueryHelper(this);this.action=new QueryAction({},{query:this});this.result=new Result({limit:Settings.RESULT_LIMIT},{query:this});this.scenario=new QueryScenario({},{query:this})},parse:function(b){this.id=this.uuid;if(b.name){this.id=b.name;this.uuid=b.name}this.model=_.extend(this.model,b);this.model.properties=_.extend({},Settings.QUERY_PROPERTIES,this.model.properties)},setProperty:function(d,c){this.model.properties[d]=c},getProperty:function(b){return this.model.properties[b]},run:function(t,n){var l=this;Saiku.ui.unblock();if(typeof this.model.properties!="undefined"&&this.model.properties["saiku.olap.query.automatic_execution"]===false&&!(t===true)){return}this.workspace.unblock();$(this.workspace.el).find(".workspace_results_info").empty();this.workspace.trigger("query:run");this.result.result=null;var r=false;var o="Query Validation failed!";var m=this.helper.model();if(m.queryType=="OLAP"){if(m.type=="QUERYMODEL"){var q=Object.keys(m.queryModel.axes.COLUMNS.hierarchies).length>0;var s=Object.keys(m.queryModel.axes.ROWS.hierarchies).length>0;var p=m.queryModel.details.axis=="COLUMNS"&&m.queryModel.details.measures.length>0;if(!s||!q||!p){o=""}if(!q&&!p){o+='<span class="i18n">You need to include at least one measure or a level on columns for a valid query.</span>'}if(!s){o+='<span class="i18n">You need to include at least one level on rows for a valid query.</span>'}if((q||p)&&s){r=true}}else{if(m.type=="MDX"){r=(m.mdx&&m.mdx.length>0);if(!r){o='<span class="i18n">You need to enter some MDX statement to execute.</span>'}}}}if(!r){this.workspace.table.clearOut();$(this.workspace.processing).html(o).show();this.workspace.adjust();Saiku.i18n.translate();return}this.workspace.table.clearOut();$(this.workspace.processing).html('<span class="processing_image">&nbsp;&nbsp;</span> <span class="i18n">Running query...</span> [&nbsp;<a class="cancel i18n" href="#cancel">Cancel</a>&nbsp;]').show();this.workspace.adjust();this.workspace.trigger("query:fetch");Saiku.i18n.translate();var k='<span class="processing_image">&nbsp;&nbsp;</span> <span class="i18n">Running query...</span> [&nbsp;<a class="cancel i18n" href="#cancel">Cancel</a>&nbsp;]';this.workspace.block(k);this.result.save({},{contentType:"application/json",data:JSON.stringify(m),error:function(){Saiku.ui.unblock();var a='<span class="i18n">Error executing query. Please check the server logs or contact your administrator!</span>';l.workspace.table.clearOut();$(l.workspace.processing).html(a).show();l.workspace.adjust();Saiku.i18n.translate()}})},enrich:function(){var b=this;this.workspace.query.action.post("/../enrich",{contentType:"application/json",data:JSON.stringify(b.model),async:false,success:function(a,d){b.model=d}})},url:function(){return"api/query/"+encodeURI(this.uuid)}});var Session=Backbone.Model.extend({username:null,password:null,sessionid:null,upgradeTimeout:null,initialize:function(c,d){_.extend(this,Backbone.Events);_.bindAll(this,"check_session","process_session","load_session","login");if(d&&d.username&&d.password){this.username=d.username;this.password=d.password;if(!Settings.DEMO){this.save({username:this.username,password:this.password},{success:this.check_session,error:this.check_session})}else{this.check_session()}}else{this.check_session()}},check_session:function(){if(this.sessionid===null||this.username===null||this.password===null){this.clear();this.fetch({success:this.process_session})}else{this.username=encodeURIComponent(options.username);this.load_session()}},load_session:function(){this.sessionworkspace=new SessionWorkspace()},process_session:function(c,d){if((d===null||d.sessionid==null)){Saiku.ui.unblock();if(Settings.DEMO){this.form=new DemoLoginForm({session:this})}else{this.form=new LoginForm({session:this})}this.form.render().open()}else{this.sessionid=d.sessionid;this.roles=d.roles;this.username=encodeURIComponent(d.username);this.language=d.language;if(typeof this.language!="undefined"&&this.language!=Saiku.i18n.locale){Saiku.i18n.locale=this.language;Saiku.i18n.automatic_i18n()}this.load_session()}return this},error:function(){$(this.form.el).dialog("open")},login:function(c,d){this.save({username:c,password:d},{dataType:"text",success:this.check_session,error:this.check_session})},logout:function(){Saiku.ui.unblock();$("#header").empty().hide();$("#tab_panel").remove();Saiku.tabs=new TabSet();Saiku.toolbar.remove();Saiku.toolbar=new Toolbar();typeof localStorage!=="undefined"&&localStorage&&localStorage.clear();this.id=_.uniqueId("queryaction_");this.clear();this.sessionid=null;this.username=null;this.password=null;this.destroy({async:false});document.location.reload(false);delete this.id},url:function(){return"session"}});var SessionWorkspace=Backbone.Model.extend({initialize:function(c,d){_.extend(this,Backbone.Events);_.bindAll(this,"process_datasources","prefetch_dimensions");this.initialized=false;this.first=true;if(typeof localStorage!=="undefined"&&localStorage){if(!Settings.LOCALSTORAGE_EXPIRATION||Settings.LOCALSTORAGE_EXPIRATION===0){localStorage.clear()}if(localStorage.getItem("expiration")&&!(localStorage.getItem("expiration")>(new Date()).getTime())){localStorage.clear()}else{if(!localStorage.getItem("saiku-version")||(localStorage.getItem("saiku-version")!==Settings.VERSION)){localStorage.clear();localStorage.setItem("saiku-version",Settings.VERSION)}}}Saiku.ui.block("Loading datasources....");this.fetch({success:this.process_datasources},{})},refresh:function(){typeof localStorage!=="undefined"&&localStorage&&localStorage.clear();this.clear();typeof localStorage!=="undefined"&&localStorage&&localStorage.setItem("saiku-version",Settings.VERSION);this.fetch({success:this.process_datasources},{})},destroy:function(){typeof localStorage!=="undefined"&&localStorage&&localStorage.clear();return false},process_datasources:function(f,d){if(typeof localStorage!=="undefined"&&localStorage&&localStorage.getItem("session")===null){localStorage.setItem("session",JSON.stringify(d));var e=(new Date()).getTime()+Settings.LOCALSTORAGE_EXPIRATION;typeof localStorage!=="undefined"&&localStorage&&localStorage.setItem("expiration",e)}this.cube_navigation=_.template($("#template-cubes").html())({connections:d});this.cube={};this.connections=d;_.delay(this.prefetch_dimensions,20);if(!this.initialized){$(Saiku.toolbar.el).prependTo($("#header"));$("#header").show();Saiku.ui.unblock();Saiku.tabs.render();if(!Settings.INITIAL_QUERY){Saiku.tabs.add(new Workspace())}Saiku.events.trigger("session:new",{session:this})}else{if(!Settings.INITIAL_QUERY){Saiku.tabs.add(new Workspace())}}},prefetch_dimensions:function(){for(var r=0,x=this.connections.length;r<x;r++){var y=this.connections[r];for(var t=0,i=y.catalogs.length;t<i;t++){var l=y.catalogs[t];for(var u=0,k=l.schemas.length;u<k;u++){var v=l.schemas[u];for(var w=0,s=v.cubes.length;w<s;w++){var z=v.cubes[w];var j=y.name+"/"+l.name+"/"+((v.name==""||v.name==null)?"null":v.name)+"/"+encodeURIComponent(z.name);if(typeof localStorage!=="undefined"&&localStorage&&localStorage.getItem("cube."+j)!==null){this.cube[j]=new Cube(JSON.parse(localStorage.getItem("cube."+j)))}else{this.cube[j]=new Cube({key:j});if(Settings.DIMENSION_PREFETCH===true){this.cube[j].fetch()}}}}}}if(!this.initialized&&Backbone.history){Backbone.history.start();this.initialized=true}},url:function(){if(this.first){this.first=false;return encodeURI(Saiku.session.username+"/discover")}else{return encodeURI(Saiku.session.username+"/discover/refresh")}}});var Member=Backbone.Model.extend({initialize:function(d,e){this.cube=e.cube;var f=e.dimension.split("/");this.hierarchy=decodeURIComponent(f[0]);this.level=decodeURIComponent(f[1])},url:function(){var b=encodeURI(Saiku.session.username+"/discover/")+this.cube+"/hierarchies/"+encodeURIComponent(this.hierarchy)+"/levels/"+encodeURIComponent(this.level);return b}});var Saiku={toolbar:{},tabs:new TabSet(),session:null,events:_.extend({},Backbone.Events),routers:[],ui:{block:function(b){$(".processing_message").html(b);$(".processing_message").removeClass("i18n_translated").addClass("i18n");Saiku.i18n.translate();$(".processing,.processing_container").show()},unblock:function(){$(".processing,.processing_container, .blockOverlay").hide();$(".blockUI").fadeOut("slow")}},log:function(c,d){if(console&&console.log){console.log("Logging for: "+c);if(d){console.log(d)}}},error:function(c,d){if(console&&console.error){console.error("Logging for: "+c);console.error(d)}}};Backbone.emulateHTTP=false;if(!Settings.BIPLUGIN){$(document).ready(function(){Saiku.session=new Session({},{username:Settings.USERNAME,password:Settings.PASSWORD});Saiku.toolbar=new Toolbar()})}var SaikuTimeLogger=function(b){this._element=$(b);this._timestamps=[];this._events=[]};SaikuTimeLogger.prototype.log=function(e){var f=(new Date()).getTime();if(!e){e="Unknown"}if(this._timestamps.length>0){var d=this._timestamps[this._timestamps.length-1];if((f-d)>1){this._element.append("<div>"+(f-d)+" ms "+e+"  (previous: "+this._events[this._events.length-1]+" )</div>")}}this._timestamps.push(f);this._events.push(e)};(function(g){var f="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",h=String.fromCharCode,e=(function(){try{document.createElement("$")}catch(a){return a}}());g.Base64||(g.Base64={encode:function(w){var b,d,c,i,s,u,t,x=0,v=w.length,r=Math.max,a="";while(x<v){b=w.charCodeAt(x++)||0;d=w.charCodeAt(x++)||0;t=w.charCodeAt(x++)||0;if(r(b,d,t)>255){throw e}c=(b>>2)&63;i=((b&3)<<4)|((d>>4)&15);s=((d&15)<<2)|((t>>6)&3);u=t&63;if(!d){s=u=64}else{if(!t){u=64}}a+=f.charAt(c)+f.charAt(i)+f.charAt(s)+f.charAt(u)}return a}})}(this));Backbone.sync=function(B,u,o){var w;methodMap={create:"POST",read:"GET",update:"PUT","delete":"DELETE"};var t=methodMap[B];var z=Settings.REST_URL+(_.isFunction(u.url)?u.url():u.url);if(typeof Settings.ERRORS=="undefined"){Settings.ERRORS=0}var r=function(){Settings.ERRORS++;if(Settings.ERRORS<Settings.ERROR_TOLERANCE){Saiku.session.logout()}else{Saiku.ui.block("Communication problem with the server. Please reload the application...")}};var A={0:function(){r()},401:function(){r()}};var y=function(c,a,b){if(!isIE&&typeof console!="undefined"&&console&&console.error){console.error("Error performing "+t+" on "+z);console.error(b)}if(o.error){o.error(c,a,b)}};var p=function(b,a,c){Settings.ERRORS=0;Saiku.ui.unblock();o.success(b,a,c)};var x=true;if(o.async===false){x=false}var s="json";if(typeof o.dataType!="undefined"){s=o.dataType}var q="application/x-www-form-urlencoded";if(typeof o.contentType!="undefined"){q=o.contentType}var v=u.attributes;if(typeof o.data!="undefined"){v=o.data}w={url:z,type:t,cache:false,data:v,contentType:q,dataType:s,success:p,statusCode:A,error:y,async:x};if((Settings.BIPLUGIN&&!Settings.BIPLUGIN5)||Backbone.emulateHTTP){if(t==="PUT"||t==="DELETE"){if(Backbone.emulateHTTP){w.data._method=t}w.type="POST";w.beforeSend=function(a){a.setRequestHeader("X-HTTP-Method-Override",t)}}}$.ajax(w)};var QueryRouter=Backbone.Router.extend({routes:{"query/open/*query_name":"open_query","query/open":"open_query_repository"},open_query:function(h){Settings.ACTION="OPEN_QUERY";var n={};var i="text";if(!Settings.BIPLUGIN5&&Settings.BIPLUGIN){var l=(Settings.GET.SOLUTION?(Settings.GET.SOLUTION+"/"):"")+(Settings.GET.PATH&&Settings.GET.PATH!="/"?(Settings.GET.PATH+"/"):"")+(Settings.GET.ACTION||"");n={file:l}}else{n={file:h}}var j=_.extend({file:n.file},Settings.PARAMS);var m={populate:function(c){if(c&&c.length>0){var a=c[0];var b=new Query(j,{name:n.file});Saiku.tabs.add(new Workspace({query:b,item:c[0]}))}else{Saiku.tabs.add(new Workspace())}Settings.INITIAL_QUERY=false}};var k=new Repository({},{dialog:m}).fetch({async:false,data:{path:n.file}})},open_query_repository:function(){Toolbar.prototype.open_query()}});Saiku.routers.push(new QueryRouter());var Statistics=Backbone.View.extend({data:{resultset:[],metadata:[]},initialize:function(b){this.workspace=b.workspace;this.id=_.uniqueId("stats_");$(this.el).attr({id:this.id});_.bindAll(this,"render","receive_data","process_data","show","setOptions");this.workspace.bind("query:result",this.receive_data);this.add_button();this.workspace.querytoolbar.stats=this.show;$(this.workspace.el).find(".workspace_results").prepend($(this.el).hide())},add_button:function(){var d=$('<a href="#stats" class="stats button disabled_toolbar i18n" title="Basic Statistics"></a>').css({"background-image":"url('js/saiku/plugins/Statistics/sigma.png')","background-repeat":"no-repeat","background-position":"50% 50%",height:"32px","margin-top":"5px"});var c=$('<li class="seperator_vertical"></li>').append(d);$(this.workspace.querytoolbar.el).find("ul.table").append(c)},show:function(d,c){$(this.workspace.table.el).toggle();$(this.el).toggle();$(d.target).toggleClass("on");if($(d.target).hasClass("on")){this.process_data({data:this.workspace.query.result.lastresult()})}else{this.workspace.table.render({data:this.workspace.query.result.lastresult()})}},setOptions:function(d){var e=$(d.target).attr("href").replace("#","");try{this[e]()}catch(f){}return false},render:function(){if(!$(this.workspace.querytoolbar.el).find(".stats").hasClass("on")||($(this.workspace.el).is(":visible")&&!$(this.el).is(":visible"))){return}var t=function(e,a){var b="<tr>";var c=a?"<th class='row_header'>":"<th class='row'>";var d=a?"<th class='col'>":"<td class='data'>";var f=a?"</th>":"</td>";_.each(e,function(g,h){b+=((h==0)?c:d)+"<div "+((h==0)?'class="i18n"':"")+">"+g+"</div>"+f});b+="</tr>";return b};var p=function(d,c,e){var b=_.map(d,function(f){return f[c]});b=_.filter(b,function(f){return(typeof f!=="undefined"&&f!=null&&(f!==""||f===0))});var a=e(b);if(b.length>0&&(typeof a!=="undefined"&&a!=null&&(a!==""||a===0))){return a.toFixed(3)}return""};var s=function(a){return _.reduce(a,function(c,b){return c+b},0)};var A=function(a){return(s(a))/a.length};var y=function(a){var b=A(a);return Math.sqrt(s(_.map(a,function(c){return Math.pow(b-c,2)}))/a.length)};var u=function(a){return _.min(a)};var q=function(a){return _.max(a)};$(this.el).empty();var B=this.data.metadata;var w=this.data.resultset;var z=_.filter(B,function(a){return !a.isHeader&&a.colType=="Numeric"});var x=_.map(z,function(a){return a.colName});var r=_.map(x,function(a){return _.indexOf(_.map(B,function(b){return b.colName}),a)});var o=$("<table style='display: table; '>");var v=$("<tbody>").appendTo(o);v.append(t(["Statistics"].concat(x),true));v.append(t(["Min"].concat(_.map(r,function(a){return p(w,a,u)})),false));v.append(t(["Max"].concat(_.map(r,function(a){return p(w,a,q)})),false));v.append(t(["Sum"].concat(_.map(r,function(a){return p(w,a,s)})),false));v.append(t(["Average"].concat(_.map(r,function(a){return p(w,a,A)})),false));v.append(t(["Std. Deviation"].concat(_.map(r,function(a){return p(w,a,y)})),false));$(this.el).append(o);Saiku.i18n.translate()},receive_data:function(b){return _.delay(this.process_data,0,b)},process_data:function(t){this.data={};this.data.resultset=[];this.data.metadata=[];this.data.height=0;this.data.width=0;if(typeof t=="undefined"||typeof t.data=="undefined"||!$(this.el).is(":visible")){return}if(t.data!=null&&t.data.error!=null){$(this.el).empty()}if(t.data==null||(t.data.cellset&&t.data.cellset.length===0)){$(this.el).empty()}if(t.data&&t.data.cellset&&t.data.cellset.length>0){var s=0;var v=true;var r=new Array();for(var m=0,n=t.data.cellset.length;m<n;m++){if(v&&(t.data.cellset[m][0].type=="ROW_HEADER_HEADER"||t.data.cellset[m][0].value=="null")){this.data.metadata=[];for(var p=0,q=t.data.cellset[m].length;p<q;p++){if(t.data.cellset[m][p].type=="ROW_HEADER_HEADER"){this.data.metadata.shift();s=p}if(r[p]){r[p].push(t.data.cellset[m][p].value)}else{r[p]=[t.data.cellset[m][p].value]}if(t.data.cellset[m][0].type=="ROW_HEADER_HEADER"){this.data.metadata.push({colIndex:p,colType:typeof(t.data.cellset[m+1][p].value)!=="number"&&isNaN(t.data.cellset[m+1][p].value.replace(/[^a-zA-Z 0-9.]+/g,""))?"String":"Numeric",colName:r[p].join(" / "),isHeader:(t.data.cellset[m][p].type=="ROW_HEADER_HEADER")})}}}else{if(t.data.cellset[m][s].value!=="null"&&t.data.cellset[m][s].value!==""){v=false;var u=[];this.data.width=t.data.cellset[m].length;for(var w=s,x=t.data.cellset[m].length;w<x;w++){var o=t.data.cellset[m][w].value;if(t.data.cellset[m][w].properties.raw&&t.data.cellset[m][w].properties.raw!=="null"){o=parseFloat(t.data.cellset[m][w].properties.raw)}else{if(typeof(t.data.cellset[m][w].value)!=="number"&&parseFloat(t.data.cellset[m][w].value.replace(/[^a-zA-Z 0-9.]+/g,""))){o=parseFloat(t.data.cellset[m][w].value.replace(/[^a-zA-Z 0-9.]+/g,""))}}if(w==s){o+=" ["+m+"]"}u.push(o)}this.data.resultset.push(u)}}}this.data.height=this.data.resultset.length;this.workspace.processing.hide();this.render()}else{$(this.el).empty();this.no_results()}},no_results:function(b){$(this.el).text("No results")},error:function(b){$(this.el).text(safe_tags_replace(b.data.error))}});Saiku.events.bind("session:new",function(j){function l(a){if(typeof a.workspace.stats=="undefined"){a.workspace.stats=new Statistics({workspace:a.workspace})}}function i(a){if(typeof a.workspace.stats!="undefined"&&$(a.workspace.stats.el).is(":visible")){$(a.workspace.stats.el).parents().find(".workspace_results table").show();$(a.workspace.stats.el).hide();a.workspace.stats.data={};a.workspace.stats.data.resultset=[];a.workspace.stats.data.metadata=[];a.workspace.stats.data.height=0;a.workspace.stats.data.width=0}}for(var g=0,h=Saiku.tabs._tabs.length;g<h;g++){var k=Saiku.tabs._tabs[g];l({workspace:k.content})}Saiku.session.bind("workspace:new",l);Saiku.session.bind("workspace:clear",i)});Saiku.i18n={locale:(navigator.language||navigator.browserLanguage||navigator.systemLanguage||navigator.userLanguage).substring(0,2).toLowerCase(),po_file:{},translate:function(b){if(b){$(b).find(".i18n").i18n(Saiku.i18n.po_file)}else{$(".i18n").i18n(Saiku.i18n.po_file)}},automatic_i18n:function(){if(Saiku.i18n.locale=="zh"){Saiku.i18n.locale="cn"}if(Saiku.i18n.locale!="en"){$.ajax({url:"js/saiku/plugins/I18n/po/"+Saiku.i18n.locale+".json",type:"GET",dataType:"json",success:function(b){Saiku.i18n.po_file=b;Saiku.i18n.translate()}})}return true},elements:[],improve_translation:function(){Saiku.tabs.add(new TranslationTab());return false}};function recursive_menu_translate(d,e){if(d&&d.hasOwnProperty("name")&&d.i18n&&e){var f=e[d.name];if(typeof f!="undefined"){d.name=f}else{if(d&&d.hasOwnProperty("name")&&e){if(Saiku.i18n.elements.indexOf(d.name)===-1){Saiku.i18n.elements.push(d.name)}}}}if(typeof d.items!="undefined"){$.each(d.items,function(b,a){recursive_menu_translate(a,e)})}}(function(b){b.fn.i18n=function(a){if(!a){return this}var d=function(c,f){if(typeof f[c]=="undefined"){return""}else{return f[c]}};return b.each(this,function(){element=b(this);if(element.html()){translated_text=d(element.html(),a);if(Saiku.i18n.elements.indexOf&&Saiku.i18n.elements.indexOf(element.html())===-1){Saiku.i18n.elements.push(element.html())}if(translated_text){element.data("original",element.html());element.html(translated_text);element.removeClass("i18n")}}if(element.attr("title")){translated_title=d(element.attr("title"),a);if(Saiku.i18n.elements.indexOf&&Saiku.i18n.elements.indexOf(element.attr("title"))===-1){Saiku.i18n.elements.push(element.attr("title"))}if(translated_title){element.data("original",element.attr("title"));element.attr({title:translated_title});element.removeClass("i18n")}}if(element.attr("value")){translated_value=d(element.attr("value"),a);if(Saiku.i18n.elements.indexOf&&Saiku.i18n.elements.indexOf(element.attr("value"))===-1){Saiku.i18n.elements.push(element.attr("value"))}if(translated_value){element.data("original",element.attr("value"));element.attr({value:translated_value});element.removeClass("i18n")}}if(element.hasClass("i18n")){element.addClass("i18n_failed")}element.addClass("i18n_translated")})};b.fn.un_i18n=function(){return b.each(this,function(){element=b(this);if(element.text()){element.text(element.data("original"))}if(element.attr("title")){element.attr({title:element.data("original")})}element.addClass("i18n");element.removeClass("i18n_translated").removeClass("i18n_failed")})}})(jQuery);var TranslationTab=Backbone.View.extend({className:"workspace_area",caption:function(){return Saiku.i18n.po_file["Improve this translation"]?Saiku.i18n.po_file["Improve this translation"]:"Improve this translation"},events:{"submit form":"submit","change input":"mark"},initialize:function(){$(window).resize(this.adjust);$(this.el).focus(this.adjust);this.adjust()},render:function(){var g={};for(var e=0,f=Saiku.i18n.elements.length;e<f;e++){g[Saiku.i18n.elements[e]]={value:Saiku.i18n.po_file[Saiku.i18n.elements[e]],name:encodeURI(Saiku.i18n.elements[e])}}var h=_.template("<form class='workspace_results'>Your name: <input type='text' name='translator_name' /><p>Please fill in the appropriate translation in the blanks provided:<p><% _.each(translation_table, function(val, key) { %><div><b><%= key %></b><br /><input type='text' value='<%= val.value %>' name='<%= val.name %>' /></div><% }); %><div><input class='submit-translation' type='submit' value='Submit translation' /></div></form>")({translation_table:g});$(this.el).html(h).find("div").css({"float":"left",padding:"20px"}).find("input").css({width:"300px"});$(this.el).find(".submit-translation").css({padding:"20px"})},mark:function(b){$(b.target).addClass("changed")},submit:function(){var b={locale:Saiku.i18n.locale};$(this.el).find(".changed").each(function(a){b[decodeURI($(this).attr("name"))]=encodeURI($(this).val())});window.location="mailto:contact@analytical-labs.com?subject=Translation for "+Saiku.i18n.locale+"&body="+JSON.stringify(b);Saiku.ui.block("Thank you for improving our translation!");this.tab.remove();_.delay(function(){Saiku.ui.unblock()},1000);return false},adjust:function(){$(this.el).height($("body").height()-87)}});Saiku.i18n.automatic_i18n();Saiku.events.bind("session:new",function(){Saiku.i18n.translate();Saiku.session.bind("tab:add",Saiku.i18n.translate);if(Saiku.i18n.locale!="en"){var d=$("<a />").text(Saiku.i18n.locale).attr({href:"#translate",title:"Improve this translation"}).click(Saiku.i18n.improve_translation).addClass("sprite translate i18n");var c=$("<li />").append(d);$(Saiku.toolbar.el).find("ul").append(c)}});if(window.logger){window.Translate=new logger({url:Settings.TELEMETRY_SERVER+"/input/translations"})};var puc={allowSave:function(b){if(window.parent.mantle_initialized!==undefined&&window.parent.mantle_initialized&&window.parent.enableAdhocSave){if(window.ALLOW_PUC_SAVE===undefined||ALLOW_PUC_SAVE){window.parent.enableAdhocSave(b)}}},refresh_repo:function(){if(window.parent.mantle_initialized!==undefined&&window.parent.mantle_initialized){window.parent.mantle_refreshRepository()}},save_to_solution:function(g,h,i,k,l){var j=Saiku.tabs._tabs[0].content.query;j.action.get("/xml",{success:function(b,c){g=g&&g.length>".saiku".length&&g.substring(g.length-".saiku".length,g.length)==".saiku"?g:g+".saiku";var a=(h?(h+"/"):"")+(i?(i+"/"):"")+(g||"");(new SavedQuery({name:g,file:a,content:c.xml})).save({success:function(){puc.refresh_repo()}})}})}};var RepositoryBrowserControllerProxy=function(){this.remoteSave=puc.save_to_solution};var Wiz=function(){this.currPgNum=0};var WaqrProxy=function(){this.wiz=new Wiz();this.repositoryBrowserController=new RepositoryBrowserControllerProxy()};var gCtrlr=new WaqrProxy();var savePg0=function(){};if(Settings.BIPLUGIN){Settings.PLUGIN=true;Settings.REST_URL="../saiku/";if(Settings.BIPLUGIN5){Settings.REST_URL="../../plugin/saiku/api/"}$(document).ready(function(){var b=Settings.REST_URL+"load/plugin/plugins";if(Settings.DEBUG){b+="?debug=true"}$.getScript(b).promise().done(function(){Saiku.session=new Session()}).fail(function(){Saiku.session=new Session()})})}var BIPlugin={bind_callbacks:function(b){$(b.toolbar.el).find(".run").parent().removeClass("seperator");b.bind("query:result",function(d){var a=d.data.cellset&&d.data.cellset.length>0;puc.allowSave(a)})}};Saiku.events.bind("session:new",function(b){if(Settings.PLUGIN){$("#header").remove();if(Saiku.tabs._tabs[0]&&Saiku.tabs._tabs[0].content){BIPlugin.bind_callbacks(Saiku.tabs._tabs[0].content)}Saiku.session.bind("workspace:new",function(a){BIPlugin.bind_callbacks(a.workspace)})}});var Datasources=Backbone.Model.extend({list:[],initialize:function(c,d){_.extend(this,Backbone.Events)},parse:function(b){this.set({list:b});return b},url:function(){return(Saiku.session.username+"/datasources")}});if(Settings.PLUGIN){window.parent.getSaikuMdx=function(){var d=this;var c=Saiku.tabs._tabs[0].content.query;c.clear();c.fetch({success:function(b,f){var a=new Datasources();a.fetch({success:function(i,r){for(var o=0,s=r.length;o<s;o++){if(r[o].name==f.cube.connectionName){var t=r[o].properties.location.split(";");var e="";var q="";$.each(t,function(g,j){var h=j.split("=");if(h[0]=="DataSource"){e=h[1]}if(h[0]=="Catalog"){q=h[1]}});var p={connection:r[o].name,catalog:q,jndi:e,mdx:f.mdx};window.parent.saveSaiku(p)}}}})}})}};var Chart=Backbone.View.extend({initialize:function(d){this.workspace=d.workspace;this.id=_.uniqueId("chart_");$(this.el).attr({id:this.id});this.renderer=new SaikuChartRenderer(null,{htmlObject:$(this.el),zoom:true,adjustSizeTo:".workspace_results"});_.bindAll(this,"receive_data","show","render_view","exportChart");var e=this;this.workspace.bind("query:run",function(){if(!$(e.workspace.querytoolbar.el).find(".render_chart").hasClass("on")){return false}e.renderer.data={};e.renderer.data.resultset=[];e.renderer.data.metadata=[];$(e.el).find(".canvas_wrapper").hide();return false});this.workspace.bind("query:result",this.receive_data);var f="<div id='nav"+this.id+"' style='display:none' class='nav'><form id='svgChartPseudoForm' target='_blank' method='POST'><input type='hidden' name='type' class='type'/><input type='hidden' name='svg' class='svg'/></form></div>";if(isIE){f="<div></div>"}this.nav=$(f);$(this.el).append(this.nav)},exportChart:function(f){var g=new XMLSerializer().serializeToString($("svg")[0]);var h='<svg xmlns="http://www.w3.org/2000/svg" ';if(g.substr(0,h.length)!=h){g=g.replace("<svg ",h)}g='<!DOCTYPE svg [<!ENTITY nbsp "&#160;">]>'+g;var e=$("#svgChartPseudoForm");e.find(".type").val(f);e.find(".svg").val(g);e.attr("action",Settings.REST_URL+this.workspace.query.url()+escape("/../../export/saiku/chart"));e.submit();return false},render_view:function(){$(this.workspace.el).find(".workspace_results").prepend($(this.el).hide())},show:function(e,g){var f=this;this.workspace.adjust();this.renderer.cccOptions.width=$(this.workspace.el).find(".workspace_results").width()-40;this.renderer.cccOptions.height=$(this.workspace.el).find(".workspace_results").height()-40;$(this.el).show();var h=this.workspace.query.result.hasRun();if(h){_.defer(function(){f.renderer.process_data_tree({data:f.workspace.query.result.lastresult()},true,true);f.renderer.switch_chart(f.renderer.type)})}},export_button:function(h){var e=this;var f=$(h.target).hasClass("button")?$(h.target):$(h.target).parent();var e=this;var g=$(document);$.contextMenu("destroy",".export_button");$.contextMenu({selector:".export_button",trigger:"left",ignoreRightClick:true,callback:function(a,b){e.workspace.chart.exportChart(a)},items:{png:{name:"PNG"},jpg:{name:"JPEG"},pdf:{name:"PDF"},svg:{name:"SVG"}}});f.contextMenu()},receive_data:function(b){if(!$(this.workspace.querytoolbar.el).find(".render_chart").hasClass("on")){return}this.workspace.adjust();this.renderer.process_data_tree(b,true,true);this.renderer.switch_chart(this.renderer.type)}});var Fullscreen=Backbone.Model.extend({initialize:function(b){this.workspace=b.workspace;_.bindAll(this,"change_handler","adjust");if(document&&document.addEventListener){document.addEventListener("fullscreenchange",this.change_handler,false);document.addEventListener("webkitfullscreenchange",this.change_handler,false);document.addEventListener("mozfullscreenchange",this.change_handler,false);this.add_button();this.workspace.bind("workspace:adjust",this.adjust)}},add_button:function(){var g=$(".workspace_results",this.workspace.el).get(0);var e=(g&&(g.requestFullscreen||g.msRequestFullscreen||g.mozRequestFullScreen||g.webkitRequestFullscreen));if(!e){return}var h=$('<a href="#fullscreen" class="fullscreen button disabled_toolbar i18n" title="Fullscreen"></a>').css({"background-image":"url('js/saiku/plugins/Fullscreen/fullscreen.png')","background-repeat":"no-repeat","background-position":"50% 50%","background-size":"16px"});var f=$('<li class="seperator"></li>').append(h);$(this.workspace.toolbar.el).find("ul").append(f);this.workspace.toolbar.fullscreen=this.show},change_handler:function(){setTimeout(function(){var b=document.fullscreenElement||document.mozFullScreenElement||document.webkitFullscreenElement;if(b){}else{this.workspace.trigger("fullscreen:disabled")}}.bind(this),50)},show:function(){var b=$(".workspace_results",this.workspace.el).get(0);if(b.requestFullscreen){b.requestFullscreen()}else{if(b.msRequestFullscreen){b.msRequestFullscreen()}else{if(b.mozRequestFullScreen){b.mozRequestFullScreen()}else{if(b.webkitRequestFullscreen){b.webkitRequestFullscreen()}}}}},adjust:function(d){var c=document.fullscreenElement||document.mozFullScreenElement||document.webkitFullscreenElement;if(c){$(c).css({height:"100%"});this.workspace.trigger("fullscreen:enabled")}}});Saiku.events.bind("session:new",function(h){function j(a){if(typeof a.workspace.fullscreen==="undefined"){a.workspace.fullscreen=new Fullscreen({workspace:a.workspace})}}for(var f=0,g=Saiku.tabs._tabs.length;f<g;f++){var i=Saiku.tabs._tabs[f];j({workspace:i.content})}Saiku.session.bind("workspace:new",j)});